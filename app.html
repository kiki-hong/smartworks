<!--
  app.html
-->

<script>
// =========================
//   ê³µí†µ ìƒíƒœ/ìœ í‹¸
// =========================
let currentUser = null;
let selectedImages = [];
let diaryFiltersLoaded = false; // ì¼ì§€ë³´ê¸° í•„í„° ë¡œë”© ì—¬ë¶€ í”Œë˜ê·¸

function fmtComma(v) {
  if (v === null || v === undefined || v === '') return '';
  const num = Number(v);
  return isNaN(num) ? v : num.toLocaleString('en-US');
}

function gasReady() {
  try { return !!(window.google && google.script && google.script.run); } 
  catch(e){ return false; }
}

function showMessage(elementId, message, type) {
  const el = document.getElementById(elementId);
  if (!el) return;
  el.innerHTML = `<div class="message ${type || ''}">${message}</div>`;
  setTimeout(() => { if (el.innerHTML.includes(message)) el.innerHTML = ''; }, 5000);
}

function setLoadingText(msg){
  const p = document.querySelector('#loading p');
  if (p) p.textContent = msg || 'ì²˜ë¦¬ ì¤‘...';
}
function showLoading(show) {
  const loading = document.getElementById('loading');
  const sections = document.querySelectorAll('.login-section, .main-section');
  if (!loading) return;
  if (show) {
    loading.style.display = 'block';
    sections.forEach(s => s.style.opacity = '0.5');
    document.body.style.pointerEvents = 'none';
    loading.style.pointerEvents = 'auto';
  } else {
    loading.style.display = 'none';
    sections.forEach(s => s.style.opacity = '1');
    document.body.style.pointerEvents = 'auto';
  }
}

let _loadingTimer = null;
function showLoadingSafe(show, timeoutMs = 15000, msg) {
  if (show) setLoadingText(msg || 'ì²˜ë¦¬ ì¤‘...');
  showLoading(show);
  clearTimeout(_loadingTimer);
  if (show) {
    _loadingTimer = setTimeout(() => {
      showLoading(false);
      showMessage('diaryMessage', 'ì„œë²„ ì‘ë‹µì´ ì§€ì—°ë©ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.', 'error');
    }, timeoutMs);
  }
}

// =========================
//   ì´ˆê¸°í™”
// =========================
window.addEventListener('load', () => {
  const today = new Date().toISOString().split('T')[0];
  const dateEl = document.getElementById('workDate');
  if (dateEl) dateEl.value = today;
  updateTimestamp();
  setInterval(updateTimestamp, 5000);

  const fileInput = document.getElementById('imageUpload');
  if (fileInput) fileInput.addEventListener('change', handleImageSelection);

  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (isStandalone && !gasReady()) {
    showMessage('loginMessage', 'í˜„ì¬ í™ˆí™”ë©´(ì•±) ëª¨ë“œì—ì„œëŠ” ì„œë²„ ì €ì¥ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €(ì‚¬íŒŒë¦¬/í¬ë¡¬)ì—ì„œ ì ‘ì†í•´ ì£¼ì„¸ìš”.', 'error');
  }

  if (typeof TEST_MODE !== 'undefined' && TEST_MODE) autoLogin();
});

// =========================
//   ìë™ ë¡œê·¸ì¸ (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)
// =========================
function autoLogin() {
  currentUser = { name: 'í…ŒìŠ¤íŠ¸', email: 'test@example.com' };
  document.getElementById('loginSection').style.display = 'none';
  document.getElementById('mainSection').style.display = 'block';
  document.getElementById('navTabs').classList.add('show');
  document.getElementById('userInfo').innerHTML = `<h3>${currentUser.name}</h3><p>${currentUser.email}</p>`;
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('workDate').value = today;
  updateTimestamp();
  showMessage('diaryMessage', '(í…ŒìŠ¤íŠ¸ ëª¨ë“œ) ë¡œê·¸ì¸ ì—†ì´ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'success');
}

// =========================
//   íƒ­ ì „í™˜
// =========================
function showTab(tabName, btnEl){
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
  if (btnEl) btnEl.classList.add('active');

  const diaryTab = document.getElementById('diaryTab');
  const roomTab  = document.getElementById('roomTab');
  const viewDiaryTab = document.getElementById('viewDiaryTab');

  [diaryTab, roomTab, viewDiaryTab].forEach(el => el && el.classList.remove('active'));

  if (tabName === 'room'){
    roomTab.classList.add('active');
    document.querySelector('.header h1').textContent = 'í˜¸ì‹¤í˜„í™©';
    document.querySelector('.header p').textContent  = 'í˜„ì¬ ìƒíƒœë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”';
    loadRoomStatus();
  } else if (tabName === 'viewDiary') {
    viewDiaryTab.classList.add('active');
    document.querySelector('.header h1').textContent = 'ì¼ì§€ë³´ê¸°';
    document.querySelector('.header p').textContent  = 'ê³¼ê±° ì—…ë¬´ì¼ì§€ë¥¼ ê²€ìƒ‰í•˜ê³  í™•ì¸í•˜ì„¸ìš”';
    loadDiaryFilters();
  } else {
    diaryTab.classList.add('active');
    document.querySelector('.header h1').textContent = 'JHT ìŠ¤ë§ˆíŠ¸ ì—…ë¬´ì¼ì§€';
    document.querySelector('.header p').textContent  = 'ì˜¤ëŠ˜ì˜ ì—…ë¬´ë¥¼ ê¸°ë¡í•˜ì„¸ìš”';
  }
}

// =========================
//   ì¼ì§€ë³´ê¸° ê¸°ëŠ¥
// =========================
function loadDiaryFilters() {
  if (diaryFiltersLoaded || !gasReady()) return;
  showLoadingSafe(true, 15000, 'í•„í„° ëª©ë¡ ë¡œë”© ì¤‘...');
  google.script.run
    .withSuccessHandler(res => {
      showLoadingSafe(false);
      if (res.success) {
        const { dates, authors, categories } = res.data;
        populateSelect('filterDate', dates);
        populateSelect('filterAuthor', authors);
        populateSelect('filterCategory', categories);
        diaryFiltersLoaded = true;
      } else {
        showMessage('viewDiaryMessage', res.message, 'error');
      }
    })
    .withFailureHandler(err => {
      showLoadingSafe(false);
      console.error(err);
      showMessage('viewDiaryMessage', 'í•„í„° ëª©ë¡ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
    })
    .getFilterOptions();
}

function populateSelect(elementId, options) {
  const select = document.getElementById(elementId);
  if (!select) return;
  const currentValue = select.value;
  select.innerHTML = ''; // Clear existing options
  options.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt;
    option.textContent = opt;
    select.appendChild(option);
  });
  select.value = currentValue;
}

function searchDiaryEntries() {
  if (!gasReady()) {
    showMessage('viewDiaryMessage', 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    return;
  }
  const filters = {
    date: document.getElementById('filterDate').value,
    author: document.getElementById('filterAuthor').value,
    category: document.getElementById('filterCategory').value,
    customerInfo: document.getElementById('filterCustomer').value.trim()
  };
  showLoadingSafe(true, 20000, 'ì¼ì§€ ê²€ìƒ‰ ì¤‘...');
  google.script.run
    .withSuccessHandler(res => {
      showLoadingSafe(false);
      if (res.success) {
        renderDiaryTable(res.data);
      } else {
        showMessage('viewDiaryMessage', res.message, 'error');
      }
    })
    .withFailureHandler(err => {
      showLoadingSafe(false);
      console.error(err);
      showMessage('viewDiaryMessage', 'ì¼ì§€ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
    })
    .getDiaryEntries(filters);
}

function renderDiaryTable(entries) {
  const tbody = document.getElementById('diaryEntriesBody');
  if (!tbody) return;
  tbody.innerHTML = '';

  if (!entries || entries.length === 0) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 8;
    td.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
    td.style.textAlign = 'center';
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  entries.forEach(entry => {
    const tr = document.createElement('tr');
    const deleteButton = (currentUser && currentUser.name === entry.author)
      ? `<button class="btn secondary" style="padding: 5px 10px; font-size: 14px;" onclick="requestDeleteEntry('${entry.id}', this)">ì‚­ì œ</button>`
      : '';

    tr.innerHTML = `
      <td>${entry.date}</td>
      <td>${entry.author}</td>
      <td>${entry.category}</td>
      <td>${entry.customerInfo}</td>
      <td>${entry.workContent}</td>
      <td>${entry.etc}</td>
      <td>${entry.image ? `<a href="${entry.image}" target="_blank">ë³´ê¸°</a>` : ''}</td>
      <td>${deleteButton}</td>
    `;
    tbody.appendChild(tr);
  });
}

function requestDeleteEntry(id, buttonEl) {
    if (!confirm('ì •ë§ ì´ ì¼ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }

    showLoadingSafe(true, 15000, 'ì‚­ì œ ì¤‘...');
    google.script.run
        .withSuccessHandler(res => {
            showLoadingSafe(false);
            if (res.success) {
                showMessage('viewDiaryMessage', 'ì¼ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                buttonEl.closest('tr').remove();
            } else {
                showMessage('viewDiaryMessage', res.message, 'error');
            }
        })
        .withFailureHandler(err => {
            showLoadingSafe(false);
            console.error(err);
            showMessage('viewDiaryMessage', 'ì‚­ì œ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        })
        .deleteDiaryEntry(id);
}


// =========================
//   ì‹œê°„/í¼ ìœ í‹¸
// =========================
function updateTimestamp() {
  const now = new Date();
  const ts = now.toLocaleString('ko-KR', {
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  });
  const el = document.getElementById('timestamp');
  if (el) el.value = ts;
}

function getFormData() {
  return {
    date: document.getElementById('workDate').value,
    author: currentUser ? currentUser.name : '',
    authorEmail: currentUser ? currentUser.email : '',
    category: document.getElementById('category').value,
    customerInfo: document.getElementById('customerInfo').value.trim(),
    workContent: document.getElementById('workContent').value.trim(),
    etc: document.getElementById('etc').value.trim(),
    timestamp: document.getElementById('timestamp').value
  };
}

// =========================
//   ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ
// =========================
function login() {
  const name  = document.getElementById('loginName').value.trim();
  const email = document.getElementById('loginEmail').value.trim();

  if (typeof TEST_MODE !== 'undefined' && TEST_MODE) { autoLogin(); return; }

  if (!name || !email) {
    showMessage('loginMessage', 'ì´ë¦„ê³¼ ì´ë©”ì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
    return;
  }
  showLoadingSafe(true, 15000, 'ì¸ì¦ ì¤‘...');

  if (!gasReady()) {
    showLoadingSafe(false);
    showMessage('loginMessage', 'ì´ í™˜ê²½ì—ì„œëŠ” ë¡œê·¸ì¸/ì œì¶œì´ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € íƒ­ìœ¼ë¡œ ì ‘ì†í•´ ì£¼ì„¸ìš”.', 'error');
    return;
  }

  google.script.run
    .withSuccessHandler(res => {
      showLoadingSafe(false);
      if (res.success) {
        currentUser = res.user;
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainSection').style.display = 'block';
        document.getElementById('navTabs').classList.add('show');
        document.getElementById('userInfo').innerHTML = `<h3>${res.user.name}</h3><p>${res.user.email}</p>`;
        showMessage('diaryMessage', 'ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ì—…ë¬´ì¼ì§€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.', 'success');
        document.getElementById('loginName').value = '';
        document.getElementById('loginEmail').value = '';
      } else {
        showMessage('loginMessage', res.message, 'error');
      }
    })
    .withFailureHandler(err => {
      showLoadingSafe(false);
      console.error(err);
      showMessage('loginMessage', 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
    })
    .validateUser(name, email);
}

function logout() {
  currentUser = null;
  document.getElementById('loginSection').style.display = 'block';
  document.getElementById('mainSection').style.display = 'none';
  document.getElementById('navTabs').classList.remove('show');
  document.getElementById('category').value = '';
  document.getElementById('customerInfo').value = '';
  document.getElementById('workContent').value = '';
  document.getElementById('etc').value = '';
  selectedImages = [];
  updateImagePreview();
  showMessage('loginMessage', 'ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

// =========================
//   ì´ë¯¸ì§€ ì„ íƒ/ë¦¬ì‚¬ì´ì¦ˆ/í”„ë¦¬ë·°
// =========================
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024, sizes = ['Bytes','KB','MB','GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
}

async function resizeImage(file, maxW=1280, maxH=1280, quality=0.8){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    reader.onerror = reject;
    reader.readAsDataURL(file);

    img.onload = ()=>{
      let { width, height } = img;
      if (width > maxW || height > maxH){
        const scale = Math.min(maxW/width, maxH/height);
        width *= scale; height *= scale;
      }
      const canvas = document.createElement('canvas');
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      const dataUrl = canvas.toDataURL('image/jpeg', quality);
      resolve({
        base64: dataUrl,
        name: file.name.replace(/\.[^.]+$/, '.jpg'),
        size: Math.round(dataUrl.length * 0.75),
        dataUrl
      });
    };
    img.onerror = reject;
  });
}

async function handleImageSelection(e){
  const files = Array.from(e.target.files || []);
  for (const f of files){
    if (!f.type.startsWith('image/')){
      showMessage('diaryMessage', 'ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
      continue;
    }
    try{
      const imageData = await resizeImage(f, 1280, 1280, 0.8);
      const isDup = selectedImages.some(img => img.name===imageData.name && img.size===imageData.size);
      if (isDup){
        showMessage('diaryMessage', `ì´ë¯¸ ì„ íƒëœ íŒŒì¼ì…ë‹ˆë‹¤: ${imageData.name}`, 'error');
        continue;
      }
      selectedImages.push(imageData);
    }catch(err){
      console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', err);
      showMessage('diaryMessage', 'ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }
  e.target.value = ''; // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ í—ˆìš©
  updateImagePreview();
}

function updateImagePreview(){
  const box = document.getElementById('imagePreview');
  if (!box) return;
  box.innerHTML = '';
  selectedImages.forEach((img, idx)=>{
    const div = document.createElement('div');
    div.className = 'preview-item';
    div.innerHTML = `
      <img src="${img.dataUrl}" alt="${img.name}">
      <div class="preview-info">
        <div class="preview-name">${img.name}</div>
        <div class="preview-size">${formatFileSize(img.size)}</div>
      </div>
      <button class="preview-remove" type="button" onclick="removeImage(${idx})">Ã—</button>`;
    box.appendChild(div);
  });
}
function removeImage(i){
  selectedImages.splice(i,1);
  updateImagePreview();
}

// =========================
//   í˜¸ì‹¤í˜„í™©
// =========================
function loadRoomStatus(){
  showLoadingSafe(true, 15000, 'í˜¸ì‹¤í˜„í™© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  if (!gasReady()){
    showLoadingSafe(false);
    showMessage('roomMessage', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ë¸Œë¼ìš°ì € íƒ­ì—ì„œ ì ‘ì†í•˜ì„¸ìš”.', 'error');
    return;
  }
  google.script.run
    .withSuccessHandler(res=>{
      showLoadingSafe(false);
      if (res?.success){
        renderRoomTable(res.data || []);
        const lu = document.getElementById('lastUpdate');
        if (lu) lu.textContent = 'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + (res.lastUpdate || '');
      } else {
        showMessage('roomMessage', res?.message || 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', 'error');
      }
    })
    .withFailureHandler(err=>{
      showLoadingSafe(false);
      console.error(err);
      showMessage('roomMessage', 'í˜¸ì‹¤í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    })
    .getRoomStatus();
}

function renderRoomTable(grid){
  const tbl = document.getElementById('roomTable');
  if (!tbl) return;
  tbl.innerHTML = '';

  // ì½”ë“œí¬ì¸íŠ¸ ê¸°ì¤€ ê¸€ì ìˆ˜ (í•œê¸€ 1ê¸€ì=1)
  const textLen = (s) => [...String(s ?? '').trim()].length;

  grid.forEach(row=>{
    const tr = document.createElement('tr');

    row.forEach(cell=>{
      const td = document.createElement('td');
      const val = (cell?.value ?? '').toString().trim();

      td.textContent = val;

      // ë°°ê²½/ê¸€ììƒ‰ ë°˜ì˜
      if (cell?.backgroundColor && cell.backgroundColor !== '#ffffff') {
        td.style.backgroundColor = cell.backgroundColor;
      }
      if (cell?.fontColor && cell.fontColor !== '#000000') {
        td.style.color = cell.fontColor;
      }
      if (!val) td.classList.add('empty');

      // ìˆ«ì(í˜¸ì‹¤ ë²ˆí˜¸ ë“±)ëŠ” ì œì™¸í•˜ê³  ìƒíƒœ í…ìŠ¤íŠ¸ë§Œ ê¸¸ì´ì— ë”°ë¼ ì¶•ì†Œ
      const isNumberLike = /^-?\d+(\.\d+)?$/.test(val);
      if (!isNumberLike && val) {
        td.classList.add('is-status');
        const len = textLen(val);
        if (len >= 6) td.classList.add('len6');
        else if (len === 5) td.classList.add('len5');
        else if (len === 4) td.classList.add('len4');
        else if (len === 3) td.classList.add('len3');
      }

      tr.appendChild(td);
    });

    tbl.appendChild(tr);
  });
}

// =========================
//   ì œì¶œ ì „ í™•ì¸ ëª¨ë‹¬
// =========================
function showConfirmModal(){
  const data = getFormData();
  if (!data.date || !data.category || !data.workContent){
    showMessage('diaryMessage', 'ë‚ ì§œ, êµ¬ë¶„, ì—…ë¬´ë‚´ìš©ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', 'error');
    return;
  }

  const body = document.getElementById('confirmContent');
  const imgs = selectedImages.length
    ? `<div class="confirm-item">
         <div class="confirm-label">ì²¨ë¶€ ì´ë¯¸ì§€ (${selectedImages.length}ê°œ)</div>
         <div class="confirm-value">
           ${selectedImages.map(i=>`â€¢ ${i.name} (${formatFileSize(i.size)})`).join('<br>')}
         </div>
       </div>` : '';

  body.innerHTML = `
    <div class="confirm-item"><div class="confirm-label">ë‚ ì§œ</div><div class="confirm-value">${data.date}</div></div>
    <div class="confirm-item"><div class="confirm-label">ì‘ì„±ì</div><div class="confirm-value">${currentUser ? currentUser.name : ''}</div></div>
    <div class="confirm-item"><div class="confirm-label">êµ¬ë¶„</div><div class="confirm-value">${data.category || '-'}</div></div>
    <div class="confirm-item"><div class="confirm-label">ê³ ê°ì •ë³´</div><div class="confirm-value">${(data.customerInfo||'(ì…ë ¥ ì—†ìŒ)').replace(/\n/g,'<br>')}</div></div>
    <div class="confirm-item"><div class="confirm-label">ì—…ë¬´ë‚´ìš©</div><div class="confirm-value">${(data.workContent||'-').replace(/\n/g,'<br>')}</div></div>
    <div class="confirm-item"><div class="confirm-label">ê¸°íƒ€</div><div class="confirm-value">${(data.etc||'(ì…ë ¥ ì—†ìŒ)').replace(/\n/g,'<br>')}</div></div>
    ${imgs}
    <div class="confirm-item"><div class="confirm-label">íƒ€ì„ìŠ¤íƒ¬í”„</div><div class="confirm-value">${data.timestamp}</div></div>
  `;

  document.getElementById('confirmModal').style.display = 'block';
}
function closeConfirmModal(){
  document.getElementById('confirmModal').style.display = 'none';
}

// =========================
//   ì œì¶œ ì‹¤í–‰ (ì§„í–‰ìƒíƒœ í‘œì‹œ)
// =========================
function submitDiary(){
  const data = getFormData();
  if (!data.author){
    showMessage('diaryMessage', 'ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”.', 'error');
    return;
  }
  closeConfirmModal();

  showLoadingSafe(true, 20000, 'ì œì¶œ ì¤‘ì…ë‹ˆë‹¤...');

  if (!gasReady()){
    showLoadingSafe(false);
    showMessage('diaryMessage', 'ì´ í™˜ê²½ì—ì„œëŠ” ì„œë²„ ì €ì¥ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €(ì‚¬íŒŒë¦¬/í¬ë¡¬)ì—ì„œ ì ‘ì†í•´ ì œì¶œí•˜ì„¸ìš”.', 'error');
    return;
  }

  if (selectedImages.length){
    const first = selectedImages[0]; // ì„œë²„ëŠ” 1ì¥ë§Œ ì €ì¥
    const imageData = { base64: first.base64, fileName: first.name };
    google.script.run
      .withSuccessHandler(handleSubmitSuccess)
      .withFailureHandler(handleSubmitError)
      .submitWorkDiaryWithImage(data, imageData);
  } else {
    google.script.run
      .withSuccessHandler(handleSubmitSuccess)
      .withFailureHandler(handleSubmitError)
      .submitWorkDiary(data);
  }
}

// =========================
//   ê²°ê³¼ ëª¨ë‹¬(ì„±ê³µ/ì‹¤íŒ¨)
// =========================
function openResultModal(html) {
  const modal = document.getElementById('resultModal');
  const body  = document.getElementById('resultBody');
  if (body) body.innerHTML = html || '';
  if (modal) modal.style.display = 'block';
}
function closeResultModal(){
  document.getElementById('resultModal').style.display = 'none';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function handleSubmitSuccess(result){
  showLoadingSafe(false);
  const ok = result?.success === true;

  // ìƒë‹¨ í† ìŠ¤íŠ¸
  let toast = ok ? 'âœ… ì—…ë¬´ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : `âš ï¸ ì˜¤ë¥˜: ${result?.message || 'ì œì¶œ ì‹¤íŒ¨'}`;
  if (ok && result.imageInfo) toast += ' (ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ)';
  if (ok && result.id !== undefined) toast += ` (ID: ${result.id})`;
  showMessage('diaryMessage', toast, ok ? 'success' : 'error');

  // ìƒì„¸ ê²°ê³¼ ëª¨ë‹¬
  if (ok) {
    const mailLine = (result.emailTried)
      ? (result.emailOk ? `ğŸ“§ í™•ì¸ ë©”ì¼ì´ <b>${(currentUser?.email)||''}</b>ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.` 
                        : `ğŸ“§ í™•ì¸ ë©”ì¼ ë°œì†¡ì„ ì‹œë„í–ˆì§€ë§Œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`)
      : `ğŸ“§ í™•ì¸ ë©”ì¼ ë°œì†¡ ì•ˆ í•¨(ì„¤ì • OFF ë˜ëŠ” ì´ë©”ì¼ ì—†ìŒ)`;

    const imgLine = result.imageInfo?.url
      ? `<a href="${result.imageInfo.url}" target="_blank" rel="noopener">ì´ë¯¸ì§€ ë³´ê¸°</a>`
      : 'ì—†ìŒ';

    openResultModal(`
      <div class="confirm-item"><div class="confirm-label">ID</div><div class="confirm-value">${result.id}</div></div>
      <div class="confirm-item"><div class="confirm-label">ì‘ì„±ì</div><div class="confirm-value">${currentUser?.name || ''} &lt;${currentUser?.email || ''}&gt;</div></div>
      <div class="confirm-item"><div class="confirm-label">ì´ë¯¸ì§€</div><div class="confirm-value">${imgLine}</div></div>
      <div class="confirm-item"><div class="confirm-label">ë©”ì¼</div><div class="confirm-value">${mailLine}</div></div>
      <p style="margin-top:8px;color:#666">í™•ì¸ì„ ëˆŒëŸ¬ ê³„ì† ì§„í–‰í•˜ì„¸ìš”.</p>
    `);

    // í¼ ë¦¬ì…‹
    setTimeout(()=>{ resetDiaryForm(); }, 50);
  } else {
    openResultModal(`
      <p style="color:#c62828; font-weight:600; margin:4px 0 10px;">ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
      <div class="confirm-item"><div class="confirm-label">ì‚¬ìœ </div><div class="confirm-value">${result?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</div></div>
    `);
  }
}

function handleSubmitError(err){
  showLoadingSafe(false);
  console.error('GAS Error:', err);
  showMessage('diaryMessage', `âŒ ì„œë²„ ì˜¤ë¥˜: ${err?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
}

// =========================
//   ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
// =========================
window.addEventListener('click', (ev)=>{
  const c = document.getElementById('confirmModal');
  const r = document.getElementById('resultModal');
  if (ev.target === c) closeConfirmModal();
  if (ev.target === r) closeResultModal();
});

// =========================
//   í¼ ë¦¬ì…‹
// =========================
function resetDiaryForm(){
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('workDate').value = today;

  const sel = document.getElementById('category');
  if (sel) sel.selectedIndex = 0;

  document.getElementById('customerInfo').value = '';
  document.getElementById('workContent').value  = '';
  document.getElementById('etc').value          = '';

  const fileInput = document.getElementById('imageUpload');
  if (fileInput) fileInput.value = '';
  selectedImages = [];
  updateImagePreview();

  updateTimestamp();
}
</script>