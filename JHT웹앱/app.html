<!--
  app.html
  견적서 모듈을 포함한 클라이언트 스크립트를 HTML 템플릿으로 제공.
  Google Apps Script HTML Service에서 이 파일을 include('app') 하여 JavaScript를 실행합니다.
  Script 내용을 <script> 태그 내부에 넣어야 브라우저가 실행 가능한 코드로 인식합니다.
-->

<script>
/*
 * JHT 스마트 업무일지 - 클라이언트 스크립트 (수정본)
 *
 * 본 스크립트는 견적서 탭에서 호실 번호를 입력했을 때 구글 시트에서 자동 계산된
 * 전용/분양 면적과 평당가를 가져와 테이블에 채우는 기능을 포함합니다. 새로 추가된
 * 서버 함수 `processQuoteRoom()`을 호출하여 A열에 호실을 기록하고 계산된 B~K열의
 * 값을 배열로 받아 사용합니다. 이 배열의 순서는 견적 시트의 B~K열 순서와 동일합니다
 * (전용 m², 전용 평, 분양 m², 분양 평, 평당가, 공급금액, 부가세, 분양금액, 용도, 상태).
 *
 * 주요 변경 사항:
 *   - renderQuoteRows()에서 호실 입력란에 onblur 이벤트를 등록하여
 *     fetchRoomQuoteInfoDebounced()를 호출합니다.
 *   - fetchRoomQuoteInfo()는 서버의 processQuoteRoom()을 호출하여
 *     반환된 값 배열로 qItems[rowIndex]의 jy_m2, by_m2, unitPrice를 채웁니다.
 *   - 기존 getRoomQuoteInfo_ 호출과 데이터 구조는 더 이상 사용하지 않습니다.
 */

// ===== 테스트 모드 (로그인 생략) =====
//   배포 시 TEST_MODE=false 로만 바꾸면 끝!
const TEST_MODE = false;  // ← 실제 운영은 false
/* const TEST_USER = { name: '홍덕기', email: 'bintan21@gmail.com' }; */

// =========================
//   공통 상태/유틸
// =========================
let currentUser = null;
let selectedImages = [];

// 숫자를 천 단위마다 콤마를 찍어 문자열로 변환합니다.
// 빈 값이나 숫자가 아닌 경우에는 그대로 반환합니다.
function fmtComma(v) {
  if (v === null || v === undefined || v === '') return '';
  const num = Number(v);
  return isNaN(num) ? v : num.toLocaleString('en-US');
}

// GAS 런타임 감지 (브라우저 탭에서만 true)
function gasReady() {
  try { return !!(window.google && google.script && google.script.run); }
  catch(e){ return false; }
}

// 상태/메시지 박스
function showMessage(elementId, message, type) {
  const el = document.getElementById(elementId);
  if (!el) return;
  el.innerHTML = `<div class="message ${type || ''}">${message}</div>`;
  setTimeout(() => { if (el.innerHTML.includes(message)) el.innerHTML = ''; }, 5000);
}

// 로딩 오버레이
function setLoadingText(msg){
  const p = document.querySelector('#loading p');
  if (p) p.textContent = msg || '처리 중...';
}
function showLoading(show) {
  const loading = document.getElementById('loading');
  const sections = document.querySelectorAll('.login-section, .main-section');
  if (!loading) return;
  if (show) {
    loading.style.display = 'block';
    sections.forEach(s => s.style.opacity = '0.5');
    document.body.style.pointerEvents = 'none';
    loading.style.pointerEvents = 'auto';
  } else {
    loading.style.display = 'none';
    sections.forEach(s => s.style.opacity = '1');
    document.body.style.pointerEvents = 'auto';
  }
}

// 로딩 세이프 (응답 지연 시 자동 해제 + 경고)
let _loadingTimer = null;
function showLoadingSafe(show, timeoutMs = 15000, msg) {
  if (show) setLoadingText(msg || '처리 중...');
  showLoading(show);
  clearTimeout(_loadingTimer);
  if (show) {
    _loadingTimer = setTimeout(() => {
      showLoading(false);
      showMessage('diaryMessage', '서버 응답이 지연됩니다. 네트워크 상태 확인 후 다시 시도하세요.', 'error');
    }, timeoutMs);
  }
}

// =========================
//   초기화
// =========================
window.addEventListener('load', () => {
  // 오늘 날짜/타임스탬프
  const today = new Date().toISOString().split('T')[0];
  const dateEl = document.getElementById('workDate');
  if (dateEl) dateEl.value = today;
  updateTimestamp();
  setInterval(updateTimestamp, 5000);

  // 파일 이벤트
  const fileInput = document.getElementById('imageUpload');
  if (fileInput) fileInput.addEventListener('change', handleImageSelection);

  // 홈화면(PWA) 알림
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (isStandalone && !gasReady()) {
    showMessage('loginMessage', '현재 홈화면(앱) 모드에서는 서버 저장이 되지 않습니다. 브라우저(사파리/크롬)에서 접속해 주세요.', 'error');
  }

  // 테스트 모드면 자동 로그인
  if (typeof TEST_MODE !== 'undefined' && TEST_MODE) autoLogin();

  // 💡 동적으로 견적 메모 입력란과 납부 조건 테이블을 삽입합니다.
  try {
    // 견적 탭에 메모 입력란을 추가: qIssuedDate 요소를 기준으로 위에 textarea를 삽입
    const issuedInput = document.getElementById('qIssuedDate');
    if (issuedInput) {
      const parentGroup = issuedInput.parentElement;
      const formContainer = parentGroup.parentElement;
      // 메모 입력란이 이미 없으면 생성
      if (!document.getElementById('qComment')) {
        const commentGroup = document.createElement('div');
        commentGroup.className = 'form-group';
        commentGroup.innerHTML = `
          <label for="qComment">메모</label>
          <textarea id="qComment" placeholder="추가 메모를 입력하세요..." rows="3" style="width:100%;"></textarea>
        `;
        formContainer.insertBefore(commentGroup, parentGroup);
      }
    }
    // 견적 탭에 납부조건 테이블 컨테이너 추가
    const quoteTab = document.getElementById('quoteTab');
    if (quoteTab) {
      const cardBody = quoteTab.querySelector('.room-card-body');
      if (cardBody && !document.getElementById('depositSchedule')) {
        const depDiv = document.createElement('div');
        depDiv.id = 'depositSchedule';
        depDiv.style.marginTop = '12px';
        depDiv.innerHTML = `
          <table class="room-table">
            <thead>
              <tr>
                <td>구분</td><td>납부비율</td><td>공급금액</td><td>부가세</td><td>납부금액</td><td>납부일자</td>
              </tr>
            </thead>
            <tbody id="depositBody"></tbody>
          </table>
        `;
        cardBody.appendChild(depDiv);
      }
    }
  } catch(e) {
    console.error('견적 메모/납부조건 삽입 오류:', e);
  }
});

// =========================
//   자동 로그인 (테스트 모드)
// =========================
function autoLogin() {
  currentUser = { ...TEST_USER };

  document.getElementById('loginSection').style.display = 'none';
  document.getElementById('mainSection').style.display = 'block';
  document.getElementById('navTabs').classList.add('show');

  document.getElementById('userInfo').innerHTML =
    `<h3>${currentUser.name}</h3><p>${currentUser.email}</p>`;

  const today = new Date().toISOString().split('T')[0];
  document.getElementById('workDate').value = today;
  updateTimestamp();

  showMessage('diaryMessage', '(테스트 모드) 로그인 없이 작성 가능합니다.', 'success');
}

// =========================
//   탭 전환 (견적서 분기 포함)
// =========================
function showTab(tabName, btnEl){
  // 탭 버튼 active 토글
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
  if (btnEl) btnEl.classList.add('active');

  // 섹션 DOM
  const diaryTab = document.getElementById('diaryTab');
  const roomTab  = document.getElementById('roomTab');
  const quoteTab = document.getElementById('quoteTab');

  // 모두 비활성화
  [diaryTab, roomTab, quoteTab].forEach(el => el && el.classList.remove('active'));

  if (tabName === 'room'){
    roomTab.classList.add('active');
    document.querySelector('.header h1').textContent = '호실현황';
    document.querySelector('.header p').textContent  = '현재 상태를 한눈에 확인하세요';
    loadRoomStatus();
    return;
  }

  if (tabName === 'quote'){
    quoteTab.classList.add('active');
    // 견적서 탭에서는 제목을 업데이트한다. 오타로 document.query.querySelector가 아닌 document.querySelector 사용
    document.querySelector('.header h1').textContent = '견적서';
    document.querySelector('.header p').textContent  = '항목을 입력하고 즉시 PDF로 다운로드하세요';
    // 최초 진입 시 기본값
    const d = document.getElementById('qIssuedDate');
    if (d && !d.value) d.value = new Date().toISOString().slice(0,10);
    if (!qItems.length) addQuoteRow(); // 최소 1행 보장
    return;
  }

  // 기본: 업무일지
  diaryTab.classList.add('active');
  document.querySelector('.header h1').textContent = 'JHT 스마트 업무일지';
  document.querySelector('.header p').textContent  = '오늘의 업무를 기록하세요';
}

// =========================
//   ✅ 견적서 모듈(1단계: PDF 생성/다운로드)
//   - showLoadingSafe, showMessage, openResultModal, currentUser 재사용
// =========================

// 메모리상의 견적 항목 배열
// 각 항목은 호실과 면적/금액/용도 정보를 포함합니다. jy_m2/by_m2는 PDF 계산용으로 남겨두고,
// jy_pyeong/by_pyeong, supply, vat, total, usage는 시트에서 가져온 값을 저장합니다.
let qItems = [];

/** 견적 폼 초기화(새로작성) */
function resetQuoteForm(){
  qItems = [];
  const tbody = document.getElementById('qItemsBody');
  if (tbody) tbody.innerHTML='';
  document.getElementById('qCustomerName').value = '';
  document.getElementById('qCustomerEmail').value = '';
  const d = document.getElementById('qIssuedDate');
  if (d) d.value = new Date().toISOString().slice(0,10);
  addQuoteRow(); // 최소 1행
}

/** 항목 행 추가/삭제/입력 바인딩 */
function addQuoteRow(){
  // 초기 항목 객체: 시트에서 채울 값들을 비워둡니다.
  qItems.push({
    roomNo:'',
    jy_m2:'',    // 전용 면적(m²) - PDF 계산용
    jy_pyeong:'',// 전용 면적(평)
    by_m2:'',    // 분양 면적(m²) - PDF 계산용
    by_pyeong:'',// 분양 면적(평)
    unitPrice:'',// 평당가
    supply:'',   // 공급금액
    vat:'',      // 부가세
    total:'',    // 분양금액
    usage:''     // 용도
  });
  renderQuoteRows();
}
function removeQuoteRow(i){
  qItems.splice(i,1);
  renderQuoteRows();
}
function bindQuoteInput(i, key, el){
  qItems[i][key] = el.value;
}

/** 항목 테이블 렌더링 (호실 입력 → onblur 시 조회) */
function renderQuoteRows(){
  const tbody = document.getElementById('qItemsBody');
  if (!tbody) return;
  tbody.innerHTML = '';

  qItems.forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <input type="text" value="${r.roomNo ?? ''}"
               oninput="bindQuoteInput(${i}, 'roomNo', this)"
               onblur="fetchRoomQuoteInfoDebounced(${i}, this.value)"
               style="width:80px; text-align:center;" />
      </td>
      <td>
        <input type="number" step="0.01" value="${r.jy_pyeong ?? ''}"
               readonly
               style="width:80px; text-align:center;" />
      </td>
      <td>
        <input type="number" step="0.01" value="${r.by_pyeong ?? ''}"
               readonly
               style="width:80px; text-align:center;" />
      </td>
      <td>
        <input type="text" value="${fmtComma(r.unitPrice ?? '')}"
               readonly
               style="width:100px; text-align:center;" />
      </td>
      <td>
        <input type="text" value="${fmtComma(r.supply ?? '')}"
               readonly
               style="width:100px; text-align:center;" />
      </td>
      <td>
        <input type="text" value="${fmtComma(r.vat ?? '')}"
               readonly
               style="width:100px; text-align:center;" />
      </td>
      <td>
        <input type="text" value="${fmtComma(r.total ?? '')}"
               readonly
               style="width:100px; text-align:center;" />
      </td>
      <td>
        <input type="text" value="${r.usage ?? ''}"
               readonly
               style="width:100px; text-align:center;" />
      </td>
      <td><button class="btn secondary" type="button" onclick="removeQuoteRow(${i})">삭제</button></td>
    `;
    tbody.appendChild(tr);
  });

  // --- 합계 행 및 납부조건 테이블 업데이트 ---
  // 합계 계산
  const sums = { jy_pyeong: 0, by_pyeong: 0, supply: 0, vat: 0, total: 0 };
  qItems.forEach(row => {
    const jp = parseFloat(row.jy_pyeong);
    const bp = parseFloat(row.by_pyeong);
    const supply = parseFloat(row.supply);
    const vat = parseFloat(row.vat);
    const tot = parseFloat(row.total);
    if (!isNaN(jp)) sums.jy_pyeong += jp;
    if (!isNaN(bp)) sums.by_pyeong += bp;
    if (!isNaN(supply)) sums.supply += supply;
    if (!isNaN(vat)) sums.vat += vat;
    if (!isNaN(tot)) sums.total += tot;
  });
  // 합계 행 추가 (아이템이 있을 때만)
  if (qItems.length > 0) {
    const sumTr = document.createElement('tr');
    sumTr.innerHTML = `
      <td><span style="font-weight:bold">합계</span></td>
      <td><input type="text" readonly style="width:80px; text-align:center;" value="${sums.jy_pyeong ? sums.jy_pyeong.toFixed(2) : ''}"></td>
      <td><input type="text" readonly style="width:80px; text-align:center;" value="${sums.by_pyeong ? sums.by_pyeong.toFixed(2) : ''}"></td>
      <td></td>
      <td><input type="text" readonly style="width:100px; text-align:center;" value="${sums.supply ? fmtComma(sums.supply) : ''}"></td>
      <td><input type="text" readonly style="width:100px; text-align:center;" value="${sums.vat ? fmtComma(sums.vat) : ''}"></td>
      <td><input type="text" readonly style="width:100px; text-align:center;" value="${sums.total ? fmtComma(sums.total) : ''}"></td>
      <td></td>
      <td></td>
    `;
    tbody.appendChild(sumTr);
  }
  // 납부조건 테이블 업데이트
  const dBody = document.getElementById('depositBody');
  if (dBody) {
    dBody.innerHTML = '';
    if (qItems.length > 0 && (sums.supply || sums.vat)) {
      const supplySum = sums.supply;
      const vatSum = sums.vat;
      const totalSum = sums.total;
      const depositRates = [10, 90];
      const depositNames = ['계약금', '잔금'];
      const depositDates = ['계약시', '입주시'];
      depositRates.forEach((rate, idx) => {
        const supplyPart = Math.round(supplySum * rate / 100);
        const vatPart = Math.round(vatSum * rate / 100);
        const pay = supplyPart + vatPart;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${depositNames[idx]}</td>
          <td>${rate}%</td>
          <td style="text-align:right;">${fmtComma(supplyPart)}</td>
          <td style="text-align:right;">${fmtComma(vatPart)}</td>
          <td style="text-align:right;">${fmtComma(pay)}</td>
          <td>${depositDates[idx]}</td>
        `;
        dBody.appendChild(tr);
      });
      // 합계 행
      const totalRow = document.createElement('tr');
      totalRow.innerHTML = `
        <td>합계</td>
        <td>100%</td>
        <td style="text-align:right;">${fmtComma(supplySum)}</td>
        <td style="text-align:right;">${fmtComma(vatSum)}</td>
        <td style="text-align:right;">${fmtComma(totalSum)}</td>
        <td></td>
      `;
      dBody.appendChild(totalRow);
    }
  }
}

/* 연속 입력시 과호출 방지 */
let _qFetchTimers = {};
function fetchRoomQuoteInfoDebounced(rowIndex, roomNo){
  clearTimeout(_qFetchTimers[rowIndex]);
  _qFetchTimers[rowIndex] = setTimeout(() => {
    fetchRoomQuoteInfo(rowIndex, roomNo);
  }, 250);
}

/**
 * 견적서 입력 중 호실 번호가 변경될 때 서버에 조회를 요청한다.
 * 서버 함수 processQuoteRoom(roomNo)는 견적서 시트의 A열에 호실을 기록하고
 * B~K열의 계산된 값을 배열로 돌려준다. 배열 순서는 다음과 같다:
 *   [ 전용 m², 전용 평, 분양 m², 분양 평, 평당가, 공급금액, 부가세, 분양금액, 용도, 상태 ]
 * 이 함수는 배열 중 필요한 값만 qItems[rowIndex]에 채워 넣는다.
 */
function fetchRoomQuoteInfo(rowIndex, roomNo) {
  if (!roomNo) return;
  if (!gasReady()) {
    showMessage('quoteMessage','서버 연결이 필요합니다.','error');
    return;
  }

  google.script.run
    .withSuccessHandler(res => {
      if (res && res.success) {
        const vals = res.values || [];
        // 현재 qItems 값을 유지하면서 필요한 필드만 업데이트
        const cur = qItems[rowIndex] || {};
        // 소수점 2자리로 표시할 함수
        const fmt2 = v => {
          if (v === null || v === undefined || v === '') return '';
          const num = Number(v);
          return isNaN(num) ? v : num.toFixed(2);
        };
        qItems[rowIndex] = {
          ...cur,
          roomNo: roomNo,
          // 면적 (m²) 값도 저장해 두어 PDF 계산에 사용합니다
          jy_m2:     vals[0] ?? cur.jy_m2,
          jy_pyeong: fmt2(vals[1] ?? cur.jy_pyeong),
          by_m2:     vals[2] ?? cur.by_m2,
          by_pyeong: fmt2(vals[3] ?? cur.by_pyeong),
          unitPrice: vals[4] ?? cur.unitPrice,
          supply:    vals[5] ?? cur.supply,
          vat:       vals[6] ?? cur.vat,
          total:     vals[7] ?? cur.total,
          usage:     vals[8] ?? cur.usage
        };
        renderQuoteRows();
        showMessage('quoteMessage', `${roomNo} 호실 정보가 자동 입력되었습니다.`, 'success');
      } else {
        showMessage('quoteMessage', res && res.message ? res.message : '호실 정보를 찾을 수 없습니다.', 'error');
      }
    })
    .withFailureHandler(err => {
      console.error(err);
      showMessage('quoteMessage','호실 조회 중 오류가 발생했습니다.','error');
    })
    .processQuoteRoom(roomNo);
}

/** 서버 호출 → PDF 생성 → 즉시 다운로드 */
function generateQuotePdf(){
  const name  = document.getElementById('qCustomerName').value.trim();
  const email = document.getElementById('qCustomerEmail').value.trim(); // 1단계에선 비워도 OK
  const issued= document.getElementById('qIssuedDate').value;

  // 기본 검증
  if (!name){
    showMessage('quoteMessage','고객명을 입력하세요.','error'); return;
  }
  if (!qItems.length || qItems.every(r => !r.roomNo)){
    showMessage('quoteMessage','최소 1개 이상의 항목을 입력하세요.','error'); return;
  }
  if (!currentUser){
    showMessage('quoteMessage','로그인 후 이용하세요.','error'); return;
  }

  // 서버로 넘어갈 데이터
  const comment = (document.getElementById('qComment')?.value || '').trim();
  const data = {
    customer: { name, email },
    issuedDate: issued,
    items: qItems,
    author: { name: currentUser.name, email: currentUser.email },
    comment: comment
  };

  showLoadingSafe(true, 20000, 'PDF 생성 중...');
  if (!gasReady()){
    showLoadingSafe(false);
    showMessage('quoteMessage','이 환경에서는 서버 저장이 지원되지 않습니다.','error');
    return;
  }

  google.script.run
    .withSuccessHandler(res=>{
      showLoadingSafe(false);
      if (res?.success){
        // 상단 토스트
        showMessage('quoteMessage', `✅ PDF 생성 완료 (ID: ${res.id})`, 'success');

        // 결과 모달에 링크 제공(Drive/브라우저)
        openResultModal(`
          <div class="confirm-item"><div class="confirm-label">견적 ID</div><div class="confirm-value">${res.id}</div></div>
          <div class="confirm-item"><div class="confirm-label">총 금액</div><div class="confirm-value">${(res?.totals?.total||0).toLocaleString()} 원</div></div>
          <div class="confirm-item"><div class="confirm-label">Drive</div><div class="confirm-value"><a href="${res?.pdf?.url||'#'}" target="_blank" rel="noopener">Drive에서 열기</a></div></div>
          <div class="confirm-item"><div class="confirm-label">PDF</div><div class="confirm-value"><a href="${res?.dataUrl||'#'}" target="_blank" rel="noopener">브라우저에서 열기</a></div></div>
          <p style="margin-top:8px;color:#666">자동 다운로드가 곧 시작됩니다.</p>
        `);

        // 브라우저 자동 다운로드 트리거
        try {
          const a = document.createElement('a');
          a.href = res.dataUrl;
          a.download = res?.pdf?.name || `quote_${res.id}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        } catch(e) { /* 브라우저별 차이 있음 */ }
      } else {
        showMessage('quoteMessage', res?.message || '처리에 실패했습니다.','error');
      }
    })
    .withFailureHandler(err=>{
      showLoadingSafe(false);
      console.error(err);
      showMessage('quoteMessage','서버 오류가 발생했습니다.','error');
    })
    .createQuotePdf_(data);  // ✅ 서버 함수 호출
}

// =========================
//   시간/폼 유틸
// =========================
function updateTimestamp() {
  const now = new Date();
  const ts = now.toLocaleString('ko-KR', {
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  });
  const el = document.getElementById('timestamp');
  if (el) el.value = ts;
}

// ⚠️ getFormData는 이 버전 하나만(아래) 사용하세요!
function getFormData() {
  return {
    date: document.getElementById('workDate').value,
    author: currentUser ? currentUser.name : '',
    authorEmail: currentUser ? currentUser.email : '', // 이메일 포함
    category: document.getElementById('category').value,
    customerInfo: document.getElementById('customerInfo').value.trim(),
    workContent: document.getElementById('workContent').value.trim(),
    etc: document.getElementById('etc').value.trim(),
    timestamp: document.getElementById('timestamp').value
  };
}

// =========================
//   로그인/로그아웃
// =========================
function login() {
  const name  = document.getElementById('loginName').value.trim();
  const email = document.getElementById('loginEmail').value.trim();

  if (typeof TEST_MODE !== 'undefined' && TEST_MODE) { autoLogin(); return; }

  if (!name || !email) {
    showMessage('loginMessage', '이름과 이메일을 모두 입력해주세요.', 'error');
    return;
  }
  showLoadingSafe(true, 15000, '인증 중...');

  if (!gasReady()) {
    showLoadingSafe(false);
    showMessage('loginMessage', '이 환경에서는 로그인/제출이 동작하지 않습니다. 브라우저 탭으로 접속해 주세요.', 'error');
    return;
  }

  google.script.run
    .withSuccessHandler(res => {
      showLoadingSafe(false);
      if (res.success) {
        currentUser = res.user;
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainSection').style.display = 'block';
        document.getElementById('navTabs').classList.add('show');
        document.getElementById('userInfo').innerHTML = `<h3>${res.user.name}</h3><p>${res.user.email}</p>`;
        showMessage('diaryMessage', '로그인되었습니다! 업무일지를 작성해주세요.', 'success');
        document.getElementById('loginName').value = '';
        document.getElementById('loginEmail').value = '';
      } else {
        showMessage('loginMessage', res.message, 'error');
      }
    })
    .withFailureHandler(err => {
      showLoadingSafe(false);
      console.error(err);
      showMessage('loginMessage', '로그인 중 오류가 발생했습니다. 다시 시도해주세요.', 'error');
    })
    .validateUser(name, email);
}

function logout() {
  currentUser = null;
  document.getElementById('loginSection').style.display = 'block';
  document.getElementById('mainSection').style.display = 'none';
  document.getElementById('navTabs').classList.remove('show');
  document.getElementById('category').value = '';
  document.getElementById('customerInfo').value = '';
  document.getElementById('workContent').value = '';
  document.getElementById('etc').value = '';
  selectedImages = [];
  updateImagePreview();
  showMessage('loginMessage', '로그아웃되었습니다.', 'success');
}

// =========================
//   이미지 선택/리사이즈/프리뷰
// =========================
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024, sizes = ['Bytes','KB','MB','GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
}

async function resizeImage(file, maxW=1280, maxH=1280, quality=0.8){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    reader.onerror = reject;
    reader.readAsDataURL(file);

    img.onload = ()=>{
      let { width, height } = img;
      if (width > maxW || height > maxH){
        const scale = Math.min(maxW/width, maxH/height);
        width *= scale; height *= scale;
      }
      const canvas = document.createElement('canvas');
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      const dataUrl = canvas.toDataURL('image/jpeg', quality);
      resolve({
        base64: dataUrl,
        name: file.name.replace(/\.[^.]+$/, '.jpg'),
        size: Math.round(dataUrl.length * 0.75),
        dataUrl
      });
    };
    img.onerror = reject;
  });
}

async function handleImageSelection(e){
  const files = Array.from(e.target.files || []);
  for (const f of files){
    if (!f.type.startsWith('image/')){
      showMessage('diaryMessage', '이미지 파일만 업로드 가능합니다.', 'error');
      continue;
    }
    try{
      const imageData = await resizeImage(f, 1280, 1280, 0.8);
      const isDup = selectedImages.some(img => img.name===imageData.name && img.size===imageData.size);
      if (isDup){
        showMessage('diaryMessage', `이미 선택된 파일입니다: ${imageData.name}`, 'error');
        continue;
      }
      selectedImages.push(imageData);
    }catch(err){
      console.error('이미지 처리 오류:', err);
      showMessage('diaryMessage', '이미지 처리 중 오류가 발생했습니다.', 'error');
    }
  }
  e.target.value = ''; // 같은 파일 재선택 허용
  updateImagePreview();
}

function updateImagePreview(){
  const box = document.getElementById('imagePreview');
  if (!box) return;
  box.innerHTML = '';
  selectedImages.forEach((img, idx)=>{
    const div = document.createElement('div');
    div.className = 'preview-item';
    div.innerHTML = `
      <img src="${img.dataUrl}" alt="${img.name}">
      <div class="preview-info">
        <div class="preview-name">${img.name}</div>
        <div class="preview-size">${formatFileSize(img.size)}</div>
      </div>
      <button class="preview-remove" type="button" onclick="removeImage(${idx})">×</button>`;
    box.appendChild(div);
  });
}
function removeImage(i){
  selectedImages.splice(i,1);
  updateImagePreview();
}

// =========================
//   호실현황
// =========================
function loadRoomStatus(){
  showLoadingSafe(true, 15000, '호실현황 불러오는 중...');
  if (!gasReady()){
    showLoadingSafe(false);
    showMessage('roomMessage', '데이터를 불러오려면 브라우저 탭에서 접속하세요.', 'error');
    return;
  }
  google.script.run
    .withSuccessHandler(res=>{
      showLoadingSafe(false);
      if (res?.success){
        renderRoomTable(res.data || []);
        const lu = document.getElementById('lastUpdate');
        if (lu) lu.textContent = '마지막 업데이트: ' + (res.lastUpdate || '');
      } else {
        showMessage('roomMessage', res?.message || '불러오기 실패', 'error');
      }
    })
    .withFailureHandler(err=>{
      showLoadingSafe(false);
      console.error(err);
      showMessage('roomMessage', '호실현황을 불러오는 중 오류가 발생했습니다.', 'error');
    })
    .getRoomStatus();
}

function renderRoomTable(grid){
  const tbl = document.getElementById('roomTable');
  if (!tbl) return;
  tbl.innerHTML = '';

  // 코드포인트 기준 글자 수 (한글 1글자=1)
  const textLen = (s) => [...String(s ?? '').trim()].length;

  grid.forEach(row=>{
    const tr = document.createElement('tr');

    row.forEach(cell=>{
      const td = document.createElement('td');
      const val = (cell?.value ?? '').toString().trim();

      td.textContent = val;

      // 배경/글자색 반영
      if (cell?.backgroundColor && cell.backgroundColor !== '#ffffff') {
        td.style.backgroundColor = cell.backgroundColor;
      }
      if (cell?.fontColor && cell.fontColor !== '#000000') {
        td.style.color = cell.fontColor;
      }
      if (!val) td.classList.add('empty');

      // 숫자(호실 번호 등)는 제외하고 상태 텍스트만 길이에 따라 축소
      const isNumberLike = /^-?\d+(\.\d+)?$/.test(val);
      if (!isNumberLike && val) {
        td.classList.add('is-status');
        const len = textLen(val);
        if (len >= 6) td.classList.add('len6');
        else if (len === 5) td.classList.add('len5');
        else if (len === 4) td.classList.add('len4');
        else if (len === 3) td.classList.add('len3');
      }

      tr.appendChild(td);
    });

    tbl.appendChild(tr);
  });
}

// =========================
//   제출 전 확인 모달
// =========================
function showConfirmModal(){
  const data = getFormData();
  if (!data.date || !data.category || !data.workContent){
    showMessage('diaryMessage', '날짜, 구분, 업무내용은 필수 입력 항목입니다.', 'error');
    return;
  }

  const body = document.getElementById('confirmContent');
  const imgs = selectedImages.length
    ? `<div class="confirm-item">
         <div class="confirm-label">첨부 이미지 (${selectedImages.length}개)</div>
         <div class="confirm-value">
           ${selectedImages.map(i=>`• ${i.name} (${formatFileSize(i.size)})`).join('<br>')}
         </div>
       </div>` : '';

  body.innerHTML = `
    <div class="confirm-item"><div class="confirm-label">날짜</div><div class="confirm-value">${data.date}</div></div>
    <div class="confirm-item"><div class="confirm-label">작성자</div><div class="confirm-value">${currentUser ? currentUser.name : ''}</div></div>
    <div class="confirm-item"><div class="confirm-label">구분</div><div class="confirm-value">${data.category || '-'}</div></div>
    <div class="confirm-item"><div class="confirm-label">고객정보</div><div class="confirm-value">${(data.customerInfo||'(입력 없음)').replace(/\n/g,'<br>')}</div></div>
    <div class="confirm-item"><div class="confirm-label">업무내용</div><div class="confirm-value">${(data.workContent||'-').replace(/\n/g,'<br>')}</div></div>
    <div class="confirm-item"><div class="confirm-label">기타</div><div class="confirm-value">${(data.etc||'(입력 없음)').replace(/\n/g,'<br>')}</div></div>
    ${imgs}
    <div class="confirm-item"><div class="confirm-label">타임스탬프</div><div class="confirm-value">${data.timestamp}</div></div>
  `;

  document.getElementById('confirmModal').style.display = 'block';
}
function closeConfirmModal(){
  document.getElementById('confirmModal').style.display = 'none';
}

// =========================
//   제출 실행 (진행상태 표시)
// =========================
function submitDiary(){
  const data = getFormData();
  if (!data.author){
    showMessage('diaryMessage', '로그인 정보가 없습니다. 다시 로그인 후 시도하세요.', 'error');
    return;
  }
  closeConfirmModal();

  showLoadingSafe(true, 20000, '제출 중입니다...');

  if (!gasReady()){
    showLoadingSafe(false);
    showMessage('diaryMessage', '이 환경에서는 서버 저장이 지원되지 않습니다. 브라우저(사파리/크롬)에서 접속해 제출하세요.', 'error');
    return;
  }

  if (selectedImages.length){
    const first = selectedImages[0]; // 서버는 1장만 저장
    const imageData = { base64: first.base64, fileName: first.name };
    google.script.run
      .withSuccessHandler(handleSubmitSuccess)
      .withFailureHandler(handleSubmitError)
      .submitWorkDiaryWithImage(data, imageData);
  } else {
    google.script.run
      .withSuccessHandler(handleSubmitSuccess)
      .withFailureHandler(handleSubmitError)
      .submitWorkDiary(data);
  }
}

// =========================
//   결과 모달(성공/실패)
// =========================
function openResultModal(html) {
  const modal = document.getElementById('resultModal');
  const body  = document.getElementById('resultBody');
  if (body) body.innerHTML = html || '';
  if (modal) modal.style.display = 'block';
}
function closeResultModal(){
  document.getElementById('resultModal').style.display = 'none';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function handleSubmitSuccess(result){
  showLoadingSafe(false);
  const ok = result?.success === true;

  // 상단 토스트
  let toast = ok ? '✅ 업무일지가 저장되었습니다.' : `⚠️ 오류: ${result?.message || '제출 실패'}`;
  if (ok && result.imageInfo) toast += ' (이미지 업로드 완료)';
  if (ok && result.id !== undefined) toast += ` (ID: ${result.id})`;
  showMessage('diaryMessage', toast, ok ? 'success' : 'error');

  // 상세 결과 모달
  if (ok) {
    const mailLine = (result.emailTried)
      ? (result.emailOk ? `📧 확인 메일이 <b>${(currentUser?.email)||''}</b>로 발송되었습니다.` 
                        : `📧 확인 메일 발송을 시도했지만 실패했습니다.`)
      : `📧 확인 메일 발송 안 함(설정 OFF 또는 이메일 없음)`;

    const imgLine = result.imageInfo?.url
      ? `<a href="${result.imageInfo.url}" target="_blank" rel="noopener">이미지 보기</a>`
      : '없음';

    openResultModal(`
      <div class="confirm-item"><div class="confirm-label">ID</div><div class="confirm-value">${result.id}</div></div>
      <div class="confirm-item"><div class="confirm-label">작성자</div><div class="confirm-value">${currentUser?.name || ''} &lt;${currentUser?.email || ''}&gt;</div></div>
      <div class="confirm-item"><div class="confirm-label">이미지</div><div class="confirm-value">${imgLine}</div></div>
      <div class="confirm-item"><div class="confirm-label">메일</div><div class="confirm-value">${mailLine}</div></div>
      <p style="margin-top:8px;color:#666">확인을 눌러 계속 진행하세요.</p>
    `);

    // 폼 리셋
    setTimeout(()=>{ resetDiaryForm(); }, 50);
  } else {
    openResultModal(`
      <p style="color:#c62828; font-weight:600; margin:4px 0 10px;">등록에 실패했습니다.</p>
      <div class="confirm-item"><div class="confirm-label">사유</div><div class="confirm-value">${result?.message || '알 수 없는 오류'}</div></div>
    `);
  }
}

function handleSubmitError(err){
  showLoadingSafe(false);
  console.error('GAS Error:', err);
  showMessage('diaryMessage', `❌ 서버 오류: ${err?.message || '알 수 없는 오류'}`, 'error');
}

// =========================
//   모달 외부 클릭 닫기
// =========================
window.addEventListener('click', (ev)=>{
  const c = document.getElementById('confirmModal');
  const r = document.getElementById('resultModal');
  if (ev.target === c) closeConfirmModal();
  if (ev.target === r) closeResultModal();
});

// =========================
//   폼 리셋
// =========================
function resetDiaryForm(){
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('workDate').value = today;

  const sel = document.getElementById('category');
  if (sel) sel.selectedIndex = 0;

  document.getElementById('customerInfo').value = '';
  document.getElementById('workContent').value  = '';
  document.getElementById('etc').value          = '';

  const fileInput = document.getElementById('imageUpload');
  if (fileInput) fileInput.value = '';
  selectedImages = [];
  updateImagePreview();

  updateTimestamp();
}
</script>