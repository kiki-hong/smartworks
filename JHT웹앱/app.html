<!--
  app.html
  ê²¬ì ì„œ ëª¨ë“ˆì„ í¬í•¨í•œ í´ë¼ì´ì–¸íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ HTML í…œí”Œë¦¿ìœ¼ë¡œ ì œê³µ.
  Google Apps Script HTML Serviceì—ì„œ ì´ íŒŒì¼ì„ include('app') í•˜ì—¬ JavaScriptë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
  Script ë‚´ìš©ì„ <script> íƒœê·¸ ë‚´ë¶€ì— ë„£ì–´ì•¼ ë¸Œë¼ìš°ì €ê°€ ì‹¤í–‰ ê°€ëŠ¥í•œ ì½”ë“œë¡œ ì¸ì‹í•©ë‹ˆë‹¤.
-->

<script>
/*
 * JHT ìŠ¤ë§ˆíŠ¸ ì—…ë¬´ì¼ì§€ - í´ë¼ì´ì–¸íŠ¸ ìŠ¤í¬ë¦½íŠ¸ (ìˆ˜ì •ë³¸)
 *
 * ë³¸ ìŠ¤í¬ë¦½íŠ¸ëŠ” ê²¬ì ì„œ íƒ­ì—ì„œ í˜¸ì‹¤ ë²ˆí˜¸ë¥¼ ì…ë ¥í–ˆì„ ë•Œ êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ìë™ ê³„ì‚°ëœ
 * ì „ìš©/ë¶„ì–‘ ë©´ì ê³¼ í‰ë‹¹ê°€ë¥¼ ê°€ì ¸ì™€ í…Œì´ë¸”ì— ì±„ìš°ëŠ” ê¸°ëŠ¥ì„ í¬í•¨í•©ë‹ˆë‹¤. ìƒˆë¡œ ì¶”ê°€ëœ
 * ì„œë²„ í•¨ìˆ˜ `processQuoteRoom()`ì„ í˜¸ì¶œí•˜ì—¬ Aì—´ì— í˜¸ì‹¤ì„ ê¸°ë¡í•˜ê³  ê³„ì‚°ëœ B~Kì—´ì˜
 * ê°’ì„ ë°°ì—´ë¡œ ë°›ì•„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ ë°°ì—´ì˜ ìˆœì„œëŠ” ê²¬ì  ì‹œíŠ¸ì˜ B~Kì—´ ìˆœì„œì™€ ë™ì¼í•©ë‹ˆë‹¤
 * (ì „ìš© mÂ², ì „ìš© í‰, ë¶„ì–‘ mÂ², ë¶„ì–‘ í‰, í‰ë‹¹ê°€, ê³µê¸‰ê¸ˆì•¡, ë¶€ê°€ì„¸, ë¶„ì–‘ê¸ˆì•¡, ìš©ë„, ìƒíƒœ).
 *
 * ì£¼ìš” ë³€ê²½ ì‚¬í•­:
 *   - renderQuoteRows()ì—ì„œ í˜¸ì‹¤ ì…ë ¥ë€ì— onblur ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•˜ì—¬
 *     fetchRoomQuoteInfoDebounced()ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
 *   - fetchRoomQuoteInfo()ëŠ” ì„œë²„ì˜ processQuoteRoom()ì„ í˜¸ì¶œí•˜ì—¬
 *     ë°˜í™˜ëœ ê°’ ë°°ì—´ë¡œ qItems[rowIndex]ì˜ jy_m2, by_m2, unitPriceë¥¼ ì±„ì›ë‹ˆë‹¤.
 *   - ê¸°ì¡´ getRoomQuoteInfo_ í˜¸ì¶œê³¼ ë°ì´í„° êµ¬ì¡°ëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
 */

// ===== í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ë¡œê·¸ì¸ ìƒëµ) =====
//   ë°°í¬ ì‹œ TEST_MODE=false ë¡œë§Œ ë°”ê¾¸ë©´ ë!
const TEST_MODE = false;  // â† ì‹¤ì œ ìš´ì˜ì€ false
/* const TEST_USER = { name: 'í™ë•ê¸°', email: 'bintan21@gmail.com' }; */

// =========================
//   ê³µí†µ ìƒíƒœ/ìœ í‹¸
// =========================
let currentUser = null;
let selectedImages = [];

// ìˆ«ìë¥¼ ì²œ ë‹¨ìœ„ë§ˆë‹¤ ì½¤ë§ˆë¥¼ ì°ì–´ ë¬¸ìì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
// ë¹ˆ ê°’ì´ë‚˜ ìˆ«ìê°€ ì•„ë‹Œ ê²½ìš°ì—ëŠ” ê·¸ëŒ€ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
function fmtComma(v) {
  if (v === null || v === undefined || v === '') return '';
  const num = Number(v);
  return isNaN(num) ? v : num.toLocaleString('en-US');
}

// GAS ëŸ°íƒ€ì„ ê°ì§€ (ë¸Œë¼ìš°ì € íƒ­ì—ì„œë§Œ true)
function gasReady() {
  try { return !!(window.google && google.script && google.script.run); }
  catch(e){ return false; }
}

// ìƒíƒœ/ë©”ì‹œì§€ ë°•ìŠ¤
function showMessage(elementId, message, type) {
  const el = document.getElementById(elementId);
  if (!el) return;
  el.innerHTML = `<div class="message ${type || ''}">${message}</div>`;
  setTimeout(() => { if (el.innerHTML.includes(message)) el.innerHTML = ''; }, 5000);
}

// ë¡œë”© ì˜¤ë²„ë ˆì´
function setLoadingText(msg){
  const p = document.querySelector('#loading p');
  if (p) p.textContent = msg || 'ì²˜ë¦¬ ì¤‘...';
}
function showLoading(show) {
  const loading = document.getElementById('loading');
  const sections = document.querySelectorAll('.login-section, .main-section');
  if (!loading) return;
  if (show) {
    loading.style.display = 'block';
    sections.forEach(s => s.style.opacity = '0.5');
    document.body.style.pointerEvents = 'none';
    loading.style.pointerEvents = 'auto';
  } else {
    loading.style.display = 'none';
    sections.forEach(s => s.style.opacity = '1');
    document.body.style.pointerEvents = 'auto';
  }
}

// ë¡œë”© ì„¸ì´í”„ (ì‘ë‹µ ì§€ì—° ì‹œ ìë™ í•´ì œ + ê²½ê³ )
let _loadingTimer = null;
function showLoadingSafe(show, timeoutMs = 15000, msg) {
  if (show) setLoadingText(msg || 'ì²˜ë¦¬ ì¤‘...');
  showLoading(show);
  clearTimeout(_loadingTimer);
  if (show) {
    _loadingTimer = setTimeout(() => {
      showLoading(false);
      showMessage('diaryMessage', 'ì„œë²„ ì‘ë‹µì´ ì§€ì—°ë©ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.', 'error');
    }, timeoutMs);
  }
}

// =========================
//   ì´ˆê¸°í™”
// =========================
window.addEventListener('load', () => {
  // ì˜¤ëŠ˜ ë‚ ì§œ/íƒ€ì„ìŠ¤íƒ¬í”„
  const today = new Date().toISOString().split('T')[0];
  const dateEl = document.getElementById('workDate');
  if (dateEl) dateEl.value = today;
  updateTimestamp();
  setInterval(updateTimestamp, 5000);

  // íŒŒì¼ ì´ë²¤íŠ¸
  const fileInput = document.getElementById('imageUpload');
  if (fileInput) fileInput.addEventListener('change', handleImageSelection);

  // í™ˆí™”ë©´(PWA) ì•Œë¦¼
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (isStandalone && !gasReady()) {
    showMessage('loginMessage', 'í˜„ì¬ í™ˆí™”ë©´(ì•±) ëª¨ë“œì—ì„œëŠ” ì„œë²„ ì €ì¥ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €(ì‚¬íŒŒë¦¬/í¬ë¡¬)ì—ì„œ ì ‘ì†í•´ ì£¼ì„¸ìš”.', 'error');
  }

  // í…ŒìŠ¤íŠ¸ ëª¨ë“œë©´ ìë™ ë¡œê·¸ì¸
  if (typeof TEST_MODE !== 'undefined' && TEST_MODE) autoLogin();

  // ğŸ’¡ ë™ì ìœ¼ë¡œ ê²¬ì  ë©”ëª¨ ì…ë ¥ë€ê³¼ ë‚©ë¶€ ì¡°ê±´ í…Œì´ë¸”ì„ ì‚½ì…í•©ë‹ˆë‹¤.
  try {
    // ê²¬ì  íƒ­ì— ë©”ëª¨ ì…ë ¥ë€ì„ ì¶”ê°€: qIssuedDate ìš”ì†Œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì— textareaë¥¼ ì‚½ì…
    const issuedInput = document.getElementById('qIssuedDate');
    if (issuedInput) {
      const parentGroup = issuedInput.parentElement;
      const formContainer = parentGroup.parentElement;
      // ë©”ëª¨ ì…ë ¥ë€ì´ ì´ë¯¸ ì—†ìœ¼ë©´ ìƒì„±
      if (!document.getElementById('qComment')) {
        const commentGroup = document.createElement('div');
        commentGroup.className = 'form-group';
        commentGroup.innerHTML = `
          <label for="qComment">ë©”ëª¨</label>
          <textarea id="qComment" placeholder="ì¶”ê°€ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3" style="width:100%;"></textarea>
        `;
        formContainer.insertBefore(commentGroup, parentGroup);
      }
    }
    // ê²¬ì  íƒ­ì— ë‚©ë¶€ì¡°ê±´ í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ì¶”ê°€
    const quoteTab = document.getElementById('quoteTab');
    if (quoteTab) {
      const cardBody = quoteTab.querySelector('.room-card-body');
      if (cardBody && !document.getElementById('depositSchedule')) {
        const depDiv = document.createElement('div');
        depDiv.id = 'depositSchedule';
        depDiv.style.marginTop = '12px';
        depDiv.innerHTML = `
          <table class="room-table">
            <thead>
              <tr>
                <td>êµ¬ë¶„</td><td>ë‚©ë¶€ë¹„ìœ¨</td><td>ê³µê¸‰ê¸ˆì•¡</td><td>ë¶€ê°€ì„¸</td><td>ë‚©ë¶€ê¸ˆì•¡</td><td>ë‚©ë¶€ì¼ì</td>
              </tr>
            </thead>
            <tbody id="depositBody"></tbody>
          </table>
        `;
        cardBody.appendChild(depDiv);
      }
    }
  } catch(e) {
    console.error('ê²¬ì  ë©”ëª¨/ë‚©ë¶€ì¡°ê±´ ì‚½ì… ì˜¤ë¥˜:', e);
  }
});

// =========================
//   ìë™ ë¡œê·¸ì¸ (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)
// =========================
function autoLogin() {
  currentUser = { ...TEST_USER };

  document.getElementById('loginSection').style.display = 'none';
  document.getElementById('mainSection').style.display = 'block';
  document.getElementById('navTabs').classList.add('show');

  document.getElementById('userInfo').innerHTML =
    `<h3>${currentUser.name}</h3><p>${currentUser.email}</p>`;

  const today = new Date().toISOString().split('T')[0];
  document.getElementById('workDate').value = today;
  updateTimestamp();

  showMessage('diaryMessage', '(í…ŒìŠ¤íŠ¸ ëª¨ë“œ) ë¡œê·¸ì¸ ì—†ì´ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'success');
}

// =========================
//   íƒ­ ì „í™˜ (ê²¬ì ì„œ ë¶„ê¸° í¬í•¨)
// =========================
function showTab(tabName, btnEl){
  // íƒ­ ë²„íŠ¼ active í† ê¸€
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
  if (btnEl) btnEl.classList.add('active');

  // ì„¹ì…˜ DOM
  const diaryTab = document.getElementById('diaryTab');
  const roomTab  = document.getElementById('roomTab');
  const quoteTab = document.getElementById('quoteTab');

  // ëª¨ë‘ ë¹„í™œì„±í™”
  [diaryTab, roomTab, quoteTab].forEach(el => el && el.classList.remove('active'));

  if (tabName === 'room'){
    roomTab.classList.add('active');
    document.querySelector('.header h1').textContent = 'í˜¸ì‹¤í˜„í™©';
    document.querySelector('.header p').textContent  = 'í˜„ì¬ ìƒíƒœë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”';
    loadRoomStatus();
    return;
  }

  if (tabName === 'quote'){
    quoteTab.classList.add('active');
    // ê²¬ì ì„œ íƒ­ì—ì„œëŠ” ì œëª©ì„ ì—…ë°ì´íŠ¸í•œë‹¤. ì˜¤íƒ€ë¡œ document.query.querySelectorê°€ ì•„ë‹Œ document.querySelector ì‚¬ìš©
    document.querySelector('.header h1').textContent = 'ê²¬ì ì„œ';
    document.querySelector('.header p').textContent  = 'í•­ëª©ì„ ì…ë ¥í•˜ê³  ì¦‰ì‹œ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”';
    // ìµœì´ˆ ì§„ì… ì‹œ ê¸°ë³¸ê°’
    const d = document.getElementById('qIssuedDate');
    if (d && !d.value) d.value = new Date().toISOString().slice(0,10);
    if (!qItems.length) addQuoteRow(); // ìµœì†Œ 1í–‰ ë³´ì¥
    return;
  }

  // ê¸°ë³¸: ì—…ë¬´ì¼ì§€
  diaryTab.classList.add('active');
  document.querySelector('.header h1').textContent = 'JHT ìŠ¤ë§ˆíŠ¸ ì—…ë¬´ì¼ì§€';
  document.querySelector('.header p').textContent  = 'ì˜¤ëŠ˜ì˜ ì—…ë¬´ë¥¼ ê¸°ë¡í•˜ì„¸ìš”';
}

// =========================
//   âœ… ê²¬ì ì„œ ëª¨ë“ˆ(1ë‹¨ê³„: PDF ìƒì„±/ë‹¤ìš´ë¡œë“œ)
//   - showLoadingSafe, showMessage, openResultModal, currentUser ì¬ì‚¬ìš©
// =========================

// ë©”ëª¨ë¦¬ìƒì˜ ê²¬ì  í•­ëª© ë°°ì—´
// ê° í•­ëª©ì€ í˜¸ì‹¤ê³¼ ë©´ì /ê¸ˆì•¡/ìš©ë„ ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤. jy_m2/by_m2ëŠ” PDF ê³„ì‚°ìš©ìœ¼ë¡œ ë‚¨ê²¨ë‘ê³ ,
// jy_pyeong/by_pyeong, supply, vat, total, usageëŠ” ì‹œíŠ¸ì—ì„œ ê°€ì ¸ì˜¨ ê°’ì„ ì €ì¥í•©ë‹ˆë‹¤.
let qItems = [];

/** ê²¬ì  í¼ ì´ˆê¸°í™”(ìƒˆë¡œì‘ì„±) */
function resetQuoteForm(){
  qItems = [];
  const tbody = document.getElementById('qItemsBody');
  if (tbody) tbody.innerHTML='';
  document.getElementById('qCustomerName').value = '';
  document.getElementById('qCustomerEmail').value = '';
  const d = document.getElementById('qIssuedDate');
  if (d) d.value = new Date().toISOString().slice(0,10);
  addQuoteRow(); // ìµœì†Œ 1í–‰
}

/** í•­ëª© í–‰ ì¶”ê°€/ì‚­ì œ/ì…ë ¥ ë°”ì¸ë”© */
function addQuoteRow(){
  // ì´ˆê¸° í•­ëª© ê°ì²´: ì‹œíŠ¸ì—ì„œ ì±„ìš¸ ê°’ë“¤ì„ ë¹„ì›Œë‘¡ë‹ˆë‹¤.
  qItems.push({
    roomNo:'',
    jy_m2:'',    // ì „ìš© ë©´ì (mÂ²) - PDF ê³„ì‚°ìš©
    jy_pyeong:'',// ì „ìš© ë©´ì (í‰)
    by_m2:'',    // ë¶„ì–‘ ë©´ì (mÂ²) - PDF ê³„ì‚°ìš©
    by_pyeong:'',// ë¶„ì–‘ ë©´ì (í‰)
    unitPrice:'',// í‰ë‹¹ê°€
    supply:'',   // ê³µê¸‰ê¸ˆì•¡
    vat:'',      // ë¶€ê°€ì„¸
    total:'',    // ë¶„ì–‘ê¸ˆì•¡
    usage:''     // ìš©ë„
  });
  renderQuoteRows();
}
function removeQuoteRow(i){
  qItems.splice(i,1);
  renderQuoteRows();
}
function bindQuoteInput(i, key, el){
  qItems[i][key] = el.value;
}

/** í•­ëª© í…Œì´ë¸” ë Œë”ë§ (í˜¸ì‹¤ ì…ë ¥ â†’ onblur ì‹œ ì¡°íšŒ) */
function renderQuoteRows(){
  const tbody = document.getElementById('qItemsBody');
  if (!tbody) return;
  tbody.innerHTML = '';

  qItems.forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <input type="text" value="${r.roomNo ?? ''}"
               oninput="bindQuoteInput(${i}, 'roomNo', this)"
               onblur="fetchRoomQuoteInfoDebounced(${i}, this.value)"
               style="width:80px; text-align:center;" />
      </td>
      <td>
        <input type="number" step="0.01" value="${r.jy_pyeong ?? ''}"
               readonly
               style="width:80px; text-align:center;" />
      </td>
      <td>
        <input type="number" step="0.01" value="${r.by_pyeong ?? ''}"
               readonly
               style="width:80px; text-align:center;" />
      </td>
      <td>
        <input type="text" value="${fmtComma(r.unitPrice ?? '')}"
               readonly
               style="width:100px; text-align:center;" />
      </td>
      <td>
        <input type="text" value="${fmtComma(r.supply ?? '')}"
               readonly
               style="width:100px; text-align:center;" />
      </td>
      <td>
        <input type="text" value="${fmtComma(r.vat ?? '')}"
               readonly
               style="width:100px; text-align:center;" />
      </td>
      <td>
        <input type="text" value="${fmtComma(r.total ?? '')}"
               readonly
               style="width:100px; text-align:center;" />
      </td>
      <td>
        <input type="text" value="${r.usage ?? ''}"
               readonly
               style="width:100px; text-align:center;" />
      </td>
      <td><button class="btn secondary" type="button" onclick="removeQuoteRow(${i})">ì‚­ì œ</button></td>
    `;
    tbody.appendChild(tr);
  });

  // --- í•©ê³„ í–‰ ë° ë‚©ë¶€ì¡°ê±´ í…Œì´ë¸” ì—…ë°ì´íŠ¸ ---
  // í•©ê³„ ê³„ì‚°
  const sums = { jy_pyeong: 0, by_pyeong: 0, supply: 0, vat: 0, total: 0 };
  qItems.forEach(row => {
    const jp = parseFloat(row.jy_pyeong);
    const bp = parseFloat(row.by_pyeong);
    const supply = parseFloat(row.supply);
    const vat = parseFloat(row.vat);
    const tot = parseFloat(row.total);
    if (!isNaN(jp)) sums.jy_pyeong += jp;
    if (!isNaN(bp)) sums.by_pyeong += bp;
    if (!isNaN(supply)) sums.supply += supply;
    if (!isNaN(vat)) sums.vat += vat;
    if (!isNaN(tot)) sums.total += tot;
  });
  // í•©ê³„ í–‰ ì¶”ê°€ (ì•„ì´í…œì´ ìˆì„ ë•Œë§Œ)
  if (qItems.length > 0) {
    const sumTr = document.createElement('tr');
    sumTr.innerHTML = `
      <td><span style="font-weight:bold">í•©ê³„</span></td>
      <td><input type="text" readonly style="width:80px; text-align:center;" value="${sums.jy_pyeong ? sums.jy_pyeong.toFixed(2) : ''}"></td>
      <td><input type="text" readonly style="width:80px; text-align:center;" value="${sums.by_pyeong ? sums.by_pyeong.toFixed(2) : ''}"></td>
      <td></td>
      <td><input type="text" readonly style="width:100px; text-align:center;" value="${sums.supply ? fmtComma(sums.supply) : ''}"></td>
      <td><input type="text" readonly style="width:100px; text-align:center;" value="${sums.vat ? fmtComma(sums.vat) : ''}"></td>
      <td><input type="text" readonly style="width:100px; text-align:center;" value="${sums.total ? fmtComma(sums.total) : ''}"></td>
      <td></td>
      <td></td>
    `;
    tbody.appendChild(sumTr);
  }
  // ë‚©ë¶€ì¡°ê±´ í…Œì´ë¸” ì—…ë°ì´íŠ¸
  const dBody = document.getElementById('depositBody');
  if (dBody) {
    dBody.innerHTML = '';
    if (qItems.length > 0 && (sums.supply || sums.vat)) {
      const supplySum = sums.supply;
      const vatSum = sums.vat;
      const totalSum = sums.total;
      const depositRates = [10, 90];
      const depositNames = ['ê³„ì•½ê¸ˆ', 'ì”ê¸ˆ'];
      const depositDates = ['ê³„ì•½ì‹œ', 'ì…ì£¼ì‹œ'];
      depositRates.forEach((rate, idx) => {
        const supplyPart = Math.round(supplySum * rate / 100);
        const vatPart = Math.round(vatSum * rate / 100);
        const pay = supplyPart + vatPart;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${depositNames[idx]}</td>
          <td>${rate}%</td>
          <td style="text-align:right;">${fmtComma(supplyPart)}</td>
          <td style="text-align:right;">${fmtComma(vatPart)}</td>
          <td style="text-align:right;">${fmtComma(pay)}</td>
          <td>${depositDates[idx]}</td>
        `;
        dBody.appendChild(tr);
      });
      // í•©ê³„ í–‰
      const totalRow = document.createElement('tr');
      totalRow.innerHTML = `
        <td>í•©ê³„</td>
        <td>100%</td>
        <td style="text-align:right;">${fmtComma(supplySum)}</td>
        <td style="text-align:right;">${fmtComma(vatSum)}</td>
        <td style="text-align:right;">${fmtComma(totalSum)}</td>
        <td></td>
      `;
      dBody.appendChild(totalRow);
    }
  }
}

/* ì—°ì† ì…ë ¥ì‹œ ê³¼í˜¸ì¶œ ë°©ì§€ */
let _qFetchTimers = {};
function fetchRoomQuoteInfoDebounced(rowIndex, roomNo){
  clearTimeout(_qFetchTimers[rowIndex]);
  _qFetchTimers[rowIndex] = setTimeout(() => {
    fetchRoomQuoteInfo(rowIndex, roomNo);
  }, 250);
}

/**
 * ê²¬ì ì„œ ì…ë ¥ ì¤‘ í˜¸ì‹¤ ë²ˆí˜¸ê°€ ë³€ê²½ë  ë•Œ ì„œë²„ì— ì¡°íšŒë¥¼ ìš”ì²­í•œë‹¤.
 * ì„œë²„ í•¨ìˆ˜ processQuoteRoom(roomNo)ëŠ” ê²¬ì ì„œ ì‹œíŠ¸ì˜ Aì—´ì— í˜¸ì‹¤ì„ ê¸°ë¡í•˜ê³ 
 * B~Kì—´ì˜ ê³„ì‚°ëœ ê°’ì„ ë°°ì—´ë¡œ ëŒë ¤ì¤€ë‹¤. ë°°ì—´ ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤:
 *   [ ì „ìš© mÂ², ì „ìš© í‰, ë¶„ì–‘ mÂ², ë¶„ì–‘ í‰, í‰ë‹¹ê°€, ê³µê¸‰ê¸ˆì•¡, ë¶€ê°€ì„¸, ë¶„ì–‘ê¸ˆì•¡, ìš©ë„, ìƒíƒœ ]
 * ì´ í•¨ìˆ˜ëŠ” ë°°ì—´ ì¤‘ í•„ìš”í•œ ê°’ë§Œ qItems[rowIndex]ì— ì±„ì›Œ ë„£ëŠ”ë‹¤.
 */
function fetchRoomQuoteInfo(rowIndex, roomNo) {
  if (!roomNo) return;
  if (!gasReady()) {
    showMessage('quoteMessage','ì„œë²„ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.','error');
    return;
  }

  google.script.run
    .withSuccessHandler(res => {
      if (res && res.success) {
        const vals = res.values || [];
        // í˜„ì¬ qItems ê°’ì„ ìœ ì§€í•˜ë©´ì„œ í•„ìš”í•œ í•„ë“œë§Œ ì—…ë°ì´íŠ¸
        const cur = qItems[rowIndex] || {};
        // ì†Œìˆ˜ì  2ìë¦¬ë¡œ í‘œì‹œí•  í•¨ìˆ˜
        const fmt2 = v => {
          if (v === null || v === undefined || v === '') return '';
          const num = Number(v);
          return isNaN(num) ? v : num.toFixed(2);
        };
        qItems[rowIndex] = {
          ...cur,
          roomNo: roomNo,
          // ë©´ì  (mÂ²) ê°’ë„ ì €ì¥í•´ ë‘ì–´ PDF ê³„ì‚°ì— ì‚¬ìš©í•©ë‹ˆë‹¤
          jy_m2:     vals[0] ?? cur.jy_m2,
          jy_pyeong: fmt2(vals[1] ?? cur.jy_pyeong),
          by_m2:     vals[2] ?? cur.by_m2,
          by_pyeong: fmt2(vals[3] ?? cur.by_pyeong),
          unitPrice: vals[4] ?? cur.unitPrice,
          supply:    vals[5] ?? cur.supply,
          vat:       vals[6] ?? cur.vat,
          total:     vals[7] ?? cur.total,
          usage:     vals[8] ?? cur.usage
        };
        renderQuoteRows();
        showMessage('quoteMessage', `${roomNo} í˜¸ì‹¤ ì •ë³´ê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
      } else {
        showMessage('quoteMessage', res && res.message ? res.message : 'í˜¸ì‹¤ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
      }
    })
    .withFailureHandler(err => {
      console.error(err);
      showMessage('quoteMessage','í˜¸ì‹¤ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.','error');
    })
    .processQuoteRoom(roomNo);
}

/** ì„œë²„ í˜¸ì¶œ â†’ PDF ìƒì„± â†’ ì¦‰ì‹œ ë‹¤ìš´ë¡œë“œ */
function generateQuotePdf(){
  const name  = document.getElementById('qCustomerName').value.trim();
  const email = document.getElementById('qCustomerEmail').value.trim(); // 1ë‹¨ê³„ì—ì„  ë¹„ì›Œë„ OK
  const issued= document.getElementById('qIssuedDate').value;

  // ê¸°ë³¸ ê²€ì¦
  if (!name){
    showMessage('quoteMessage','ê³ ê°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.','error'); return;
  }
  if (!qItems.length || qItems.every(r => !r.roomNo)){
    showMessage('quoteMessage','ìµœì†Œ 1ê°œ ì´ìƒì˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.','error'); return;
  }
  if (!currentUser){
    showMessage('quoteMessage','ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.','error'); return;
  }

  // ì„œë²„ë¡œ ë„˜ì–´ê°ˆ ë°ì´í„°
  const comment = (document.getElementById('qComment')?.value || '').trim();
  const data = {
    customer: { name, email },
    issuedDate: issued,
    items: qItems,
    author: { name: currentUser.name, email: currentUser.email },
    comment: comment
  };

  showLoadingSafe(true, 20000, 'PDF ìƒì„± ì¤‘...');
  if (!gasReady()){
    showLoadingSafe(false);
    showMessage('quoteMessage','ì´ í™˜ê²½ì—ì„œëŠ” ì„œë²„ ì €ì¥ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.','error');
    return;
  }

  google.script.run
    .withSuccessHandler(res=>{
      showLoadingSafe(false);
      if (res?.success){
        // ìƒë‹¨ í† ìŠ¤íŠ¸
        showMessage('quoteMessage', `âœ… PDF ìƒì„± ì™„ë£Œ (ID: ${res.id})`, 'success');

        // ê²°ê³¼ ëª¨ë‹¬ì— ë§í¬ ì œê³µ(Drive/ë¸Œë¼ìš°ì €)
        openResultModal(`
          <div class="confirm-item"><div class="confirm-label">ê²¬ì  ID</div><div class="confirm-value">${res.id}</div></div>
          <div class="confirm-item"><div class="confirm-label">ì´ ê¸ˆì•¡</div><div class="confirm-value">${(res?.totals?.total||0).toLocaleString()} ì›</div></div>
          <div class="confirm-item"><div class="confirm-label">Drive</div><div class="confirm-value"><a href="${res?.pdf?.url||'#'}" target="_blank" rel="noopener">Driveì—ì„œ ì—´ê¸°</a></div></div>
          <div class="confirm-item"><div class="confirm-label">PDF</div><div class="confirm-value"><a href="${res?.dataUrl||'#'}" target="_blank" rel="noopener">ë¸Œë¼ìš°ì €ì—ì„œ ì—´ê¸°</a></div></div>
          <p style="margin-top:8px;color:#666">ìë™ ë‹¤ìš´ë¡œë“œê°€ ê³§ ì‹œì‘ë©ë‹ˆë‹¤.</p>
        `);

        // ë¸Œë¼ìš°ì € ìë™ ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
        try {
          const a = document.createElement('a');
          a.href = res.dataUrl;
          a.download = res?.pdf?.name || `quote_${res.id}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        } catch(e) { /* ë¸Œë¼ìš°ì €ë³„ ì°¨ì´ ìˆìŒ */ }
      } else {
        showMessage('quoteMessage', res?.message || 'ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error');
      }
    })
    .withFailureHandler(err=>{
      showLoadingSafe(false);
      console.error(err);
      showMessage('quoteMessage','ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.','error');
    })
    .createQuotePdf_(data);  // âœ… ì„œë²„ í•¨ìˆ˜ í˜¸ì¶œ
}

// =========================
//   ì‹œê°„/í¼ ìœ í‹¸
// =========================
function updateTimestamp() {
  const now = new Date();
  const ts = now.toLocaleString('ko-KR', {
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  });
  const el = document.getElementById('timestamp');
  if (el) el.value = ts;
}

// âš ï¸ getFormDataëŠ” ì´ ë²„ì „ í•˜ë‚˜ë§Œ(ì•„ë˜) ì‚¬ìš©í•˜ì„¸ìš”!
function getFormData() {
  return {
    date: document.getElementById('workDate').value,
    author: currentUser ? currentUser.name : '',
    authorEmail: currentUser ? currentUser.email : '', // ì´ë©”ì¼ í¬í•¨
    category: document.getElementById('category').value,
    customerInfo: document.getElementById('customerInfo').value.trim(),
    workContent: document.getElementById('workContent').value.trim(),
    etc: document.getElementById('etc').value.trim(),
    timestamp: document.getElementById('timestamp').value
  };
}

// =========================
//   ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ
// =========================
function login() {
  const name  = document.getElementById('loginName').value.trim();
  const email = document.getElementById('loginEmail').value.trim();

  if (typeof TEST_MODE !== 'undefined' && TEST_MODE) { autoLogin(); return; }

  if (!name || !email) {
    showMessage('loginMessage', 'ì´ë¦„ê³¼ ì´ë©”ì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
    return;
  }
  showLoadingSafe(true, 15000, 'ì¸ì¦ ì¤‘...');

  if (!gasReady()) {
    showLoadingSafe(false);
    showMessage('loginMessage', 'ì´ í™˜ê²½ì—ì„œëŠ” ë¡œê·¸ì¸/ì œì¶œì´ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € íƒ­ìœ¼ë¡œ ì ‘ì†í•´ ì£¼ì„¸ìš”.', 'error');
    return;
  }

  google.script.run
    .withSuccessHandler(res => {
      showLoadingSafe(false);
      if (res.success) {
        currentUser = res.user;
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainSection').style.display = 'block';
        document.getElementById('navTabs').classList.add('show');
        document.getElementById('userInfo').innerHTML = `<h3>${res.user.name}</h3><p>${res.user.email}</p>`;
        showMessage('diaryMessage', 'ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ì—…ë¬´ì¼ì§€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.', 'success');
        document.getElementById('loginName').value = '';
        document.getElementById('loginEmail').value = '';
      } else {
        showMessage('loginMessage', res.message, 'error');
      }
    })
    .withFailureHandler(err => {
      showLoadingSafe(false);
      console.error(err);
      showMessage('loginMessage', 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
    })
    .validateUser(name, email);
}

function logout() {
  currentUser = null;
  document.getElementById('loginSection').style.display = 'block';
  document.getElementById('mainSection').style.display = 'none';
  document.getElementById('navTabs').classList.remove('show');
  document.getElementById('category').value = '';
  document.getElementById('customerInfo').value = '';
  document.getElementById('workContent').value = '';
  document.getElementById('etc').value = '';
  selectedImages = [];
  updateImagePreview();
  showMessage('loginMessage', 'ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

// =========================
//   ì´ë¯¸ì§€ ì„ íƒ/ë¦¬ì‚¬ì´ì¦ˆ/í”„ë¦¬ë·°
// =========================
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024, sizes = ['Bytes','KB','MB','GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
}

async function resizeImage(file, maxW=1280, maxH=1280, quality=0.8){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    reader.onerror = reject;
    reader.readAsDataURL(file);

    img.onload = ()=>{
      let { width, height } = img;
      if (width > maxW || height > maxH){
        const scale = Math.min(maxW/width, maxH/height);
        width *= scale; height *= scale;
      }
      const canvas = document.createElement('canvas');
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      const dataUrl = canvas.toDataURL('image/jpeg', quality);
      resolve({
        base64: dataUrl,
        name: file.name.replace(/\.[^.]+$/, '.jpg'),
        size: Math.round(dataUrl.length * 0.75),
        dataUrl
      });
    };
    img.onerror = reject;
  });
}

async function handleImageSelection(e){
  const files = Array.from(e.target.files || []);
  for (const f of files){
    if (!f.type.startsWith('image/')){
      showMessage('diaryMessage', 'ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
      continue;
    }
    try{
      const imageData = await resizeImage(f, 1280, 1280, 0.8);
      const isDup = selectedImages.some(img => img.name===imageData.name && img.size===imageData.size);
      if (isDup){
        showMessage('diaryMessage', `ì´ë¯¸ ì„ íƒëœ íŒŒì¼ì…ë‹ˆë‹¤: ${imageData.name}`, 'error');
        continue;
      }
      selectedImages.push(imageData);
    }catch(err){
      console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', err);
      showMessage('diaryMessage', 'ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }
  e.target.value = ''; // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ í—ˆìš©
  updateImagePreview();
}

function updateImagePreview(){
  const box = document.getElementById('imagePreview');
  if (!box) return;
  box.innerHTML = '';
  selectedImages.forEach((img, idx)=>{
    const div = document.createElement('div');
    div.className = 'preview-item';
    div.innerHTML = `
      <img src="${img.dataUrl}" alt="${img.name}">
      <div class="preview-info">
        <div class="preview-name">${img.name}</div>
        <div class="preview-size">${formatFileSize(img.size)}</div>
      </div>
      <button class="preview-remove" type="button" onclick="removeImage(${idx})">Ã—</button>`;
    box.appendChild(div);
  });
}
function removeImage(i){
  selectedImages.splice(i,1);
  updateImagePreview();
}

// =========================
//   í˜¸ì‹¤í˜„í™©
// =========================
function loadRoomStatus(){
  showLoadingSafe(true, 15000, 'í˜¸ì‹¤í˜„í™© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  if (!gasReady()){
    showLoadingSafe(false);
    showMessage('roomMessage', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ë¸Œë¼ìš°ì € íƒ­ì—ì„œ ì ‘ì†í•˜ì„¸ìš”.', 'error');
    return;
  }
  google.script.run
    .withSuccessHandler(res=>{
      showLoadingSafe(false);
      if (res?.success){
        renderRoomTable(res.data || []);
        const lu = document.getElementById('lastUpdate');
        if (lu) lu.textContent = 'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + (res.lastUpdate || '');
      } else {
        showMessage('roomMessage', res?.message || 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', 'error');
      }
    })
    .withFailureHandler(err=>{
      showLoadingSafe(false);
      console.error(err);
      showMessage('roomMessage', 'í˜¸ì‹¤í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    })
    .getRoomStatus();
}

function renderRoomTable(grid){
  const tbl = document.getElementById('roomTable');
  if (!tbl) return;
  tbl.innerHTML = '';

  // ì½”ë“œí¬ì¸íŠ¸ ê¸°ì¤€ ê¸€ì ìˆ˜ (í•œê¸€ 1ê¸€ì=1)
  const textLen = (s) => [...String(s ?? '').trim()].length;

  grid.forEach(row=>{
    const tr = document.createElement('tr');

    row.forEach(cell=>{
      const td = document.createElement('td');
      const val = (cell?.value ?? '').toString().trim();

      td.textContent = val;

      // ë°°ê²½/ê¸€ììƒ‰ ë°˜ì˜
      if (cell?.backgroundColor && cell.backgroundColor !== '#ffffff') {
        td.style.backgroundColor = cell.backgroundColor;
      }
      if (cell?.fontColor && cell.fontColor !== '#000000') {
        td.style.color = cell.fontColor;
      }
      if (!val) td.classList.add('empty');

      // ìˆ«ì(í˜¸ì‹¤ ë²ˆí˜¸ ë“±)ëŠ” ì œì™¸í•˜ê³  ìƒíƒœ í…ìŠ¤íŠ¸ë§Œ ê¸¸ì´ì— ë”°ë¼ ì¶•ì†Œ
      const isNumberLike = /^-?\d+(\.\d+)?$/.test(val);
      if (!isNumberLike && val) {
        td.classList.add('is-status');
        const len = textLen(val);
        if (len >= 6) td.classList.add('len6');
        else if (len === 5) td.classList.add('len5');
        else if (len === 4) td.classList.add('len4');
        else if (len === 3) td.classList.add('len3');
      }

      tr.appendChild(td);
    });

    tbl.appendChild(tr);
  });
}

// =========================
//   ì œì¶œ ì „ í™•ì¸ ëª¨ë‹¬
// =========================
function showConfirmModal(){
  const data = getFormData();
  if (!data.date || !data.category || !data.workContent){
    showMessage('diaryMessage', 'ë‚ ì§œ, êµ¬ë¶„, ì—…ë¬´ë‚´ìš©ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', 'error');
    return;
  }

  const body = document.getElementById('confirmContent');
  const imgs = selectedImages.length
    ? `<div class="confirm-item">
         <div class="confirm-label">ì²¨ë¶€ ì´ë¯¸ì§€ (${selectedImages.length}ê°œ)</div>
         <div class="confirm-value">
           ${selectedImages.map(i=>`â€¢ ${i.name} (${formatFileSize(i.size)})`).join('<br>')}
         </div>
       </div>` : '';

  body.innerHTML = `
    <div class="confirm-item"><div class="confirm-label">ë‚ ì§œ</div><div class="confirm-value">${data.date}</div></div>
    <div class="confirm-item"><div class="confirm-label">ì‘ì„±ì</div><div class="confirm-value">${currentUser ? currentUser.name : ''}</div></div>
    <div class="confirm-item"><div class="confirm-label">êµ¬ë¶„</div><div class="confirm-value">${data.category || '-'}</div></div>
    <div class="confirm-item"><div class="confirm-label">ê³ ê°ì •ë³´</div><div class="confirm-value">${(data.customerInfo||'(ì…ë ¥ ì—†ìŒ)').replace(/\n/g,'<br>')}</div></div>
    <div class="confirm-item"><div class="confirm-label">ì—…ë¬´ë‚´ìš©</div><div class="confirm-value">${(data.workContent||'-').replace(/\n/g,'<br>')}</div></div>
    <div class="confirm-item"><div class="confirm-label">ê¸°íƒ€</div><div class="confirm-value">${(data.etc||'(ì…ë ¥ ì—†ìŒ)').replace(/\n/g,'<br>')}</div></div>
    ${imgs}
    <div class="confirm-item"><div class="confirm-label">íƒ€ì„ìŠ¤íƒ¬í”„</div><div class="confirm-value">${data.timestamp}</div></div>
  `;

  document.getElementById('confirmModal').style.display = 'block';
}
function closeConfirmModal(){
  document.getElementById('confirmModal').style.display = 'none';
}

// =========================
//   ì œì¶œ ì‹¤í–‰ (ì§„í–‰ìƒíƒœ í‘œì‹œ)
// =========================
function submitDiary(){
  const data = getFormData();
  if (!data.author){
    showMessage('diaryMessage', 'ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”.', 'error');
    return;
  }
  closeConfirmModal();

  showLoadingSafe(true, 20000, 'ì œì¶œ ì¤‘ì…ë‹ˆë‹¤...');

  if (!gasReady()){
    showLoadingSafe(false);
    showMessage('diaryMessage', 'ì´ í™˜ê²½ì—ì„œëŠ” ì„œë²„ ì €ì¥ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €(ì‚¬íŒŒë¦¬/í¬ë¡¬)ì—ì„œ ì ‘ì†í•´ ì œì¶œí•˜ì„¸ìš”.', 'error');
    return;
  }

  if (selectedImages.length){
    const first = selectedImages[0]; // ì„œë²„ëŠ” 1ì¥ë§Œ ì €ì¥
    const imageData = { base64: first.base64, fileName: first.name };
    google.script.run
      .withSuccessHandler(handleSubmitSuccess)
      .withFailureHandler(handleSubmitError)
      .submitWorkDiaryWithImage(data, imageData);
  } else {
    google.script.run
      .withSuccessHandler(handleSubmitSuccess)
      .withFailureHandler(handleSubmitError)
      .submitWorkDiary(data);
  }
}

// =========================
//   ê²°ê³¼ ëª¨ë‹¬(ì„±ê³µ/ì‹¤íŒ¨)
// =========================
function openResultModal(html) {
  const modal = document.getElementById('resultModal');
  const body  = document.getElementById('resultBody');
  if (body) body.innerHTML = html || '';
  if (modal) modal.style.display = 'block';
}
function closeResultModal(){
  document.getElementById('resultModal').style.display = 'none';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function handleSubmitSuccess(result){
  showLoadingSafe(false);
  const ok = result?.success === true;

  // ìƒë‹¨ í† ìŠ¤íŠ¸
  let toast = ok ? 'âœ… ì—…ë¬´ì¼ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : `âš ï¸ ì˜¤ë¥˜: ${result?.message || 'ì œì¶œ ì‹¤íŒ¨'}`;
  if (ok && result.imageInfo) toast += ' (ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ)';
  if (ok && result.id !== undefined) toast += ` (ID: ${result.id})`;
  showMessage('diaryMessage', toast, ok ? 'success' : 'error');

  // ìƒì„¸ ê²°ê³¼ ëª¨ë‹¬
  if (ok) {
    const mailLine = (result.emailTried)
      ? (result.emailOk ? `ğŸ“§ í™•ì¸ ë©”ì¼ì´ <b>${(currentUser?.email)||''}</b>ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.` 
                        : `ğŸ“§ í™•ì¸ ë©”ì¼ ë°œì†¡ì„ ì‹œë„í–ˆì§€ë§Œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`)
      : `ğŸ“§ í™•ì¸ ë©”ì¼ ë°œì†¡ ì•ˆ í•¨(ì„¤ì • OFF ë˜ëŠ” ì´ë©”ì¼ ì—†ìŒ)`;

    const imgLine = result.imageInfo?.url
      ? `<a href="${result.imageInfo.url}" target="_blank" rel="noopener">ì´ë¯¸ì§€ ë³´ê¸°</a>`
      : 'ì—†ìŒ';

    openResultModal(`
      <div class="confirm-item"><div class="confirm-label">ID</div><div class="confirm-value">${result.id}</div></div>
      <div class="confirm-item"><div class="confirm-label">ì‘ì„±ì</div><div class="confirm-value">${currentUser?.name || ''} &lt;${currentUser?.email || ''}&gt;</div></div>
      <div class="confirm-item"><div class="confirm-label">ì´ë¯¸ì§€</div><div class="confirm-value">${imgLine}</div></div>
      <div class="confirm-item"><div class="confirm-label">ë©”ì¼</div><div class="confirm-value">${mailLine}</div></div>
      <p style="margin-top:8px;color:#666">í™•ì¸ì„ ëˆŒëŸ¬ ê³„ì† ì§„í–‰í•˜ì„¸ìš”.</p>
    `);

    // í¼ ë¦¬ì…‹
    setTimeout(()=>{ resetDiaryForm(); }, 50);
  } else {
    openResultModal(`
      <p style="color:#c62828; font-weight:600; margin:4px 0 10px;">ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
      <div class="confirm-item"><div class="confirm-label">ì‚¬ìœ </div><div class="confirm-value">${result?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</div></div>
    `);
  }
}

function handleSubmitError(err){
  showLoadingSafe(false);
  console.error('GAS Error:', err);
  showMessage('diaryMessage', `âŒ ì„œë²„ ì˜¤ë¥˜: ${err?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
}

// =========================
//   ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
// =========================
window.addEventListener('click', (ev)=>{
  const c = document.getElementById('confirmModal');
  const r = document.getElementById('resultModal');
  if (ev.target === c) closeConfirmModal();
  if (ev.target === r) closeResultModal();
});

// =========================
//   í¼ ë¦¬ì…‹
// =========================
function resetDiaryForm(){
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('workDate').value = today;

  const sel = document.getElementById('category');
  if (sel) sel.selectedIndex = 0;

  document.getElementById('customerInfo').value = '';
  document.getElementById('workContent').value  = '';
  document.getElementById('etc').value          = '';

  const fileInput = document.getElementById('imageUpload');
  if (fileInput) fileInput.value = '';
  selectedImages = [];
  updateImagePreview();

  updateTimestamp();
}
</script>